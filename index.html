<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Chicken | Enterprise BI Ultimate 2.1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Light Theme */
            --primary: #f59e0b;      /* Amber/Orange */
            --primary-dark: #b45309;
            --primary-light: #fcd34d;
            --secondary: #1e293b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --success: #10b981;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --header-height: 70px;
        }

        body.dark-mode {
            --secondary: #0f172a;
            --bg-body: #020617;
            --bg-card: #1e293b;
            --border: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; transition: background-color 0.3s; }

        /* --- Layout --- */
        aside { width: 260px; background-color: var(--secondary); color: #cbd5e1; display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease; z-index: 50; }
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* --- Components --- */
        .brand { padding: 24px; background: rgba(255,255,255,0.05); font-size: 1.2rem; font-weight: 800; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand i { color: var(--primary); }
        
        .nav-menu { flex: 1; overflow-y: auto; padding: 15px 10px; }
        .nav-item { padding: 12px 15px; margin-bottom: 4px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; transition: 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: white; }
        .nav-item.active { background: linear-gradient(90deg, rgba(245, 158, 11, 0.2) 0%, rgba(0,0,0,0) 100%); color: var(--primary); border-left: 3px solid var(--primary); }

        /* Header */
        header { background: var(--bg-card); height: var(--header-height); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 24px; flex-shrink: 0; z-index: 40; }
        .header-left h1 { margin: 0; font-size: 1.25rem; font-weight: 700; }
        .control-group { background: var(--bg-body); padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
        select { border: none; background: transparent; font-weight: 600; color: var(--text-main); cursor: pointer; }
        
        .btn { padding: 8px 16px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-weight: 500; }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: var(--secondary); color: white; border: none; }
        .theme-toggle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--bg-body); border: 1px solid var(--border); cursor: pointer; }

        /* Tabs */
        .tabs { background: var(--bg-card); padding: 0 24px; border-bottom: 1px solid var(--border); display: flex; gap: 30px; flex-shrink: 0; }
        .tab-btn { padding: 16px 0; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text-muted); position: relative; font-size: 0.9rem; }
        .tab-btn.active { color: var(--secondary); }
        body.dark-mode .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: var(--primary); border-radius: 3px 3px 0 0; }

        /* Views */
        .view-container { flex: 1; overflow: hidden; position: relative; background: var(--bg-body); }
        .view { display: none; height: 100%; overflow-y: auto; padding: 24px; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px; margin-bottom: 30px; }
        .kpi-card { background: var(--bg-card); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; overflow: hidden; transition: transform 0.3s; }
        .kpi-card:hover { transform: translateY(-4px); border-color: var(--primary-light); }
        .kpi-value { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
        .kpi-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }

        /* Charts */
        .chart-row { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 30px; }
        .chart-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-title { font-size: 1.1rem; font-weight: 700; margin: 0; }
        
        /* Tables */
        .table-container { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
        .table-toolbar { padding: 15px 20px; border-bottom: 1px solid var(--border); background: var(--bg-body); display: flex; justify-content: space-between; }
        .data-table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: var(--bg-body); color: var(--text-muted); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; padding: 15px; text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .num { font-family: 'Courier New', monospace; text-align: right; }

        /* Input Grid (Dual Inputs) */
        .input-table-wrapper { border-radius: var(--radius); border: 1px solid var(--border); overflow: auto; background: var(--bg-card); }
        .entry-table { min-width: 1000px; }
        .entry-table th { background: var(--secondary); color: white; border-color: rgba(255,255,255,0.1); }
        .day-cell { background: var(--bg-body); font-weight: bold; text-align: center; width: 60px; position: sticky; left: 0; z-index: 10; border-right: 2px solid var(--primary); }
        
        /* Dual Input Styling */
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        .form-input { width: 100%; padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-body); color: var(--text-main); font-size: 0.8rem; text-align: right; transition: 0.2s; }
        .form-input:focus { border-color: var(--primary); background: #fffbeb; }
        .form-input.sales-input { border-bottom: 1px solid #ddd; }
        .form-input.trn-input { color: var(--text-muted); font-size: 0.75rem; }

        /* Utilities */
        .toast { position: fixed; bottom: 30px; right: 30px; background: var(--secondary); color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: 0.3s; z-index: 1000; display: flex; align-items: center; gap: 10px; }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        /* SVG */
        svg { width: 100%; height: 100%; overflow: visible; }
        .chart-tooltip { position: absolute; background: var(--secondary); color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; pointer-events: none; opacity: 0; transition: 0.2s; z-index: 10; white-space: nowrap; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        /* Responsive */
        @media (max-width: 768px) {
            aside { position: fixed; bottom: 0; width: 100%; height: 60px; flex-direction: row; border-top: 1px solid var(--border); }
            .brand, .nav-item span { display: none; }
            .nav-menu { display: flex; justify-content: space-around; width: 100%; }
            .nav-item { flex-direction: column; gap: 4px; font-size: 0.7rem; }
            main { margin-bottom: 60px; }
            .chart-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside>
        <div class="brand"><i class="fas fa-drumstick-bite"></i> <span>Crispy BI</span></div>
        <div class="nav-menu" id="navList"></div>
    </aside>

    <!-- Main Content -->
    <main>
        <header>
            <div class="header-left">
                <h1>Executive <span>Dashboard</span></h1>
            </div>
            <div class="header-controls">
                <div class="control-group">
                    <select id="branchSelector" onchange="app.filterBranch(this.value)">
                        <option value="all">All Branches</option>
                    </select>
                </div>
                <div class="control-group">
                    <select id="monthSelector" onchange="app.updatePeriod()">
                        <option value="2024-01">Jan</option>
                        <option value="2024-02">Feb</option>
                        <option value="2024-03">Mar</option>
                        <option value="2024-04">Apr</option>
                        <option value="2024-05">May</option>
                        <option value="2024-06">Jun</option>
                        <option value="2024-07">Jul</option>
                        <option value="2024-08">Aug</option>
                        <option value="2024-09">Sep</option>
                        <option value="2024-10">Oct</option>
                        <option value="2024-11">Nov</option>
                        <option value="2024-12">Dec</option>
                    </select>
                </div>
                <div class="theme-toggle" onclick="app.toggleTheme()"><i class="fas fa-moon"></i></div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="app.switchTab('dashboard')">Overview</button>
            <button class="tab-btn" onclick="app.switchTab('entry')">Data Entry</button>
            <button class="tab-btn" onclick="app.switchTab('branches')">Branch Analysis</button>
        </div>

        <div class="view-container">
            
            <!-- VIEW 1: Executive Overview -->
            <div id="view-dashboard" class="view active">
                <!-- KPIs -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Total Revenue</div>
                        <div class="kpi-value" id="kpiSales">$0</div>
                        <div style="font-size:0.8rem; color:var(--success);">All Channels</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Total Orders</div>
                        <div class="kpi-value" id="kpiTrn">0</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">Transactions</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Avg Check</div>
                        <div class="kpi-value" id="kpiAvg">$0</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">Per Order</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Delivery Rev</div>
                        <div class="kpi-value" id="kpiDel">$0</div>
                        <div style="font-size:0.8rem; color:var(--primary);">3rd Party + Own</div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="chart-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Revenue by Branch</h3>
                        </div>
                        <div style="position: relative; height: 250px;">
                            <svg id="branchChart"></svg>
                            <div id="barTooltip" class="chart-tooltip"></div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header"><h3 class="chart-title">Sales Channel Mix</h3></div>
                        <div style="position: relative; height: 250px;">
                            <svg id="channelChart" viewBox="0 0 300 300"></svg>
                        </div>
                    </div>
                </div>

                <!-- NEW: Delivery Trend Line Chart -->
                <div class="chart-card" style="margin-bottom: 30px; border-left: 4px solid var(--primary);">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title" style="margin:0;">Daily Delivery Trend (All Branches)</h3>
                            <p style="margin:5px 0 0; font-size:0.8rem; color:var(--text-muted);">Aggregation: Delivery, Keeta, Careem, Noon, Deliveroo, Smiles</p>
                        </div>
                    </div>
                    <div style="position: relative; height: 200px;">
                        <svg id="trendChart"></svg>
                        <div id="trendTooltip" class="chart-tooltip"></div>
                    </div>
                </div>

                <!-- Detailed Table -->
                <div class="table-container">
                    <div class="table-toolbar">
                        <strong>Branch Performance Summary</strong>
                        <button class="btn btn-primary" onclick="app.exportCSV()">Export CSV</button>
                    </div>
                    <div class="data-table-wrapper">
                        <table id="branchTable">
                            <thead><tr><th>Branch</th><th>Sales</th><th>TRN</th><th>Avg Check</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: Data Entry (Dual Input) -->
            <div id="view-entry" class="view">
                <div class="control-group" style="margin-bottom: 20px; background: var(--bg-card); padding: 15px;">
                    <strong>Editing:</strong>
                    <select id="entryBranchSelect" onchange="app.changeEntryBranch(this.value)"></select>
                    <span style="color:var(--text-muted); margin: 0 10px;">|</span>
                    <span id="entryMonthLabel" style="color:var(--text-muted);"></span>
                    <span style="margin-left:auto; font-size:0.8rem; color:var(--text-muted);">
                        <i class="fas fa-info-circle"></i> Enter Sales (Top) and Count (Bottom)
                    </span>
                </div>

                <div class="input-table-wrapper">
                    <table class="entry-table" id="entryTable">
                        <!-- Generated by JS -->
                    </table>
                </div>
            </div>

             <!-- VIEW 3: Branch Analysis -->
             <div id="view-branches" class="view">
                <div class="table-container">
                    <div class="table-toolbar"><strong>Full Branch Comparison</strong></div>
                    <div class="data-table-wrapper">
                        <table id="fullBranchTable">
                            <thead><tr><th>Branch</th><th>Rev</th><th>Trn</th><th>Avg</th><th>Best Channel</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="toast" class="toast"><i class="fas fa-check-circle"></i> Data Saved</div>

    <script>
        // --- Config ---
        const CONFIG = {
            branches: ["Hamdan St", "Khaldia", "Shabiya 11", "Muroor", "Al Electra", "Al Barsha", "Al Satwa", "Al Rigga", "Al Majaz"],
            channels: [
                { id: 'dine_in', label: 'Dine In' },
                { id: 'delivery', label: 'Delivery' },
                { id: 'online', label: 'Online' },
                { id: 'keeta', label: 'Keeta' },
                { id: 'noon', label: 'NOON' },
                { id: 'careem', label: 'Careem' },
                { id: 'smiles', label: 'SMILES' },
                { id: 'delivero', label: 'Deliveroo' }
            ],
            // Channels to aggregate for the trend report
            deliveryChannels: ['delivery', 'keeta', 'noon', 'careem', 'smiles', 'delivero']
        };

        let state = {
            db: {},
            currentMonth: new Date().toISOString().slice(0, 7),
            activeBranchIdx: 0,
            activeFilter: 'all'
        };

        // --- Core Logic ---
        const app = {
            init: () => {
                document.getElementById('monthSelector').value = state.currentMonth;
                app.loadData();
                app.renderNav();
                app.populateSelects();
                app.updatePeriod();
            },

            loadData: () => {
                const saved = localStorage.getItem('crispy_db_v2');
                if(saved) state.db = JSON.parse(saved);
                else CONFIG.branches.forEach(b => state.db[b] = {});
            },

            saveData: () => {
                localStorage.setItem('crispy_db_v2', JSON.stringify(state.db));
                const t = document.getElementById('toast');
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2000);
                app.updatePeriod();
            },

            // --- Entry Table (FIX: Dual Input) ---
            renderEntryTable: () => {
                const table = document.getElementById('entryTable');
                const [y, m] = state.currentMonth.split('-').map(Number);
                const days = new Date(y, m, 0).getDate();
                const bName = CONFIG.branches[state.activeBranchIdx];
                
                let html = `<thead><tr><th class="day-cell">Day</th>`;
                CONFIG.channels.forEach(c => html += `<th>${c.label}</th>`);
                html += `</tr></thead><tbody>`;

                for(let d=1; d<=days; d++) {
                    const iso = `${state.currentMonth}-${String(d).padStart(2,'0')}`;
                    html += `<tr><td class="day-cell">${d}</td>`;
                    
                    CONFIG.channels.forEach(c => {
                        // Retrieve existing values
                        const dayData = state.db[bName][iso] ? state.db[bName][iso][c.id] : null;
                        const sales = dayData ? (dayData.sales || '') : '';
                        const trn = dayData ? (dayData.trn || '') : '';

                        html += `
                            <td>
                                <div class="input-group">
                                    <input type="number" class="form-input sales-input" placeholder="$" value="${sales}" 
                                    oninput="app.handleInput('${iso}', '${c.id}', 'sales', this.value)">
                                    <input type="number" class="form-input trn-input" placeholder="#" value="${trn}" 
                                    oninput="app.handleInput('${iso}', '${c.id}', 'trn', this.value)">
                                </div>
                            </td>`;
                    });
                    html += `</tr>`;
                }
                table.innerHTML = html;
            },

            // Handle Input (Sales OR Trn)
            handleInput: (iso, chId, key, val) => {
                const bName = CONFIG.branches[state.activeBranchIdx];
                if(!state.db[bName][iso]) state.db[bName][iso] = {};
                if(!state.db[bName][iso][chId]) state.db[bName][iso][chId] = {};
                
                // Save specific key
                state.db[bName][iso][chId][key] = key === 'sales' ? parseFloat(val) || 0 : parseInt(val) || 0;
                
                // Auto-calc logic could go here if needed, but manual is preferred for accuracy
                
                // Debounce save
                if(window.saveTimeout) clearTimeout(window.saveTimeout);
                window.saveTimeout = setTimeout(() => app.saveData(), 1000);
            },

            // --- Data Processing ---
            processData: () => {
                const [y, m] = state.currentMonth.split('-').map(Number);
                const days = new Date(y, m, 0).getDate();

                let total = { sales:0, trn:0, deliverySales:0 };
                let branches = [];

                CONFIG.branches.forEach(b => {
                    let row = { name: b, sales:0, trn:0, deliverySales:0, channels: {} };
                    CONFIG.channels.forEach(c => row.channels[c.id] = 0);

                    for(let d=1; d<=days; d++) {
                        const iso = `${state.currentMonth}-${String(d).padStart(2,'0')}`;
                        const dayData = state.db[b][iso] || {};
                        
                        Object.keys(dayData).forEach(ch => {
                            const s = parseFloat(dayData[ch].sales) || 0;
                            const t = parseInt(dayData[ch].trn) || 0;
                            
                            row.sales += s; row.trn += t;
                            if(row.channels[ch] !== undefined) row.channels[ch] += s;
                            
                            // Check if delivery channel
                            if(CONFIG.deliveryChannels.includes(ch)) {
                                row.deliverySales += s;
                            }
                        });
                    }
                    row.avg = row.trn > 0 ? row.sales / row.trn : 0;
                    
                    branches.push(row);
                    total.sales += row.sales;
                    total.trn += row.trn;
                    total.deliverySales += row.deliverySales;
                });

                return { branches, total };
            },

            // Calculate Daily Trend for Delivery
            getDeliveryTrend: () => {
                const [y, m] = state.currentMonth.split('-').map(Number);
                const days = new Date(y, m, 0).getDate();
                const trendData = [];

                for(let d=1; d<=days; d++) {
                    const iso = `${state.currentMonth}-${String(d).padStart(2,'0')}`;
                    let dayTotal = 0;
                    
                    // Sum all delivery channels for this day across ALL branches
                    CONFIG.branches.forEach(b => {
                        const branchDay = state.db[b][iso] || {};
                        Object.keys(branchDay).forEach(ch => {
                            if(CONFIG.deliveryChannels.includes(ch)) {
                                dayTotal += parseFloat(branchDay[ch].sales) || 0;
                            }
                        });
                    });
                    trendData.push({ day: d, value: dayTotal });
                }
                return trendData;
            },

            // --- Rendering ---
            updatePeriod: () => {
                state.currentMonth = document.getElementById('monthSelector').value;
                const monthName = new Date(state.currentMonth + '-01').toLocaleString('default', { month: 'long', year: 'numeric' });
                document.getElementById('entryMonthLabel').textContent = monthName;

                const data = app.processData();
                
                // KPIs
                const cur = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits:0 }).format(n);
                document.getElementById('kpiSales').textContent = cur(data.total.sales);
                document.getElementById('kpiTrn').textContent = data.total.trn.toLocaleString();
                document.getElementById('kpiAvg').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(data.total.trn > 0 ? data.total.sales/data.total.trn : 0);
                document.getElementById('kpiDel').textContent = cur(data.total.deliverySales);

                // Charts
                app.renderBarChart(data.branches);
                app.renderDonutChart(data.branches);
                app.renderTrendChart(); // New Line Chart
                
                // Tables
                app.renderTables(data.branches);
                app.renderEntryTable(); // Refresh Entry inputs if changed
            },

            // NEW: Line Chart for Delivery Trend
            renderTrendChart: () => {
                const svg = document.getElementById('trendChart');
                const tooltip = document.getElementById('trendTooltip');
                svg.innerHTML = '';
                
                const data = app.getDeliveryTrend();
                const w = svg.clientWidth || 800;
                const h = svg.clientHeight || 200;
                const pad = 20;

                const maxVal = Math.max(...data.map(d => d.value), 100); // Minimum 100 scale

                // Grid Lines
                for(let i=0; i<=4; i++) {
                    const y = h - pad - (i/4)*(h - pad*2);
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", pad); line.setAttribute("y1", y);
                    line.setAttribute("x2", w - pad); line.setAttribute("y2", y);
                    line.setAttribute("stroke", "var(--border)");
                    line.setAttribute("stroke-dasharray", "4");
                    svg.appendChild(line);
                }

                // Path Generation
                let points = "";
                const stepX = (w - pad*2) / (data.length - 1);
                
                data.forEach((d, i) => {
                    const x = pad + i * stepX;
                    const y = h - pad - (d.value / maxVal) * (h - pad*2);
                    points += `${x},${y} `;

                    // Dots
                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", x); circle.setAttribute("cy", y);
                    circle.setAttribute("r", 4); circle.setAttribute("fill", "var(--primary)");
                    circle.setAttribute("class", "trend-point");
                    circle.style.cursor = "pointer";

                    // Interactivity
                    circle.onmouseover = (e) => {
                        tooltip.style.opacity = 1;
                        tooltip.style.left = (e.pageX + 10) + 'px';
                        tooltip.style.top = (e.pageY - 30) + 'px';
                        tooltip.innerHTML = `<strong>Day ${d.day}</strong><br>Sales: $${d.value.toFixed(2)}`;
                        circle.setAttribute("r", 7);
                    };
                    circle.onmouseout = () => {
                        tooltip.style.opacity = 0;
                        circle.setAttribute("r", 4);
                    };

                    svg.appendChild(circle);
                });

                // Draw Line
                const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                polyline.setAttribute("points", points);
                polyline.setAttribute("fill", "none");
                polyline.setAttribute("stroke", "var(--primary)");
                polyline.setAttribute("stroke-width", "3");
                polyline.setAttribute("stroke-linejoin", "round");
                svg.insertBefore(polyline, svg.firstChild);
            },

            renderBarChart: (data) => {
                const svg = document.getElementById('branchChart');
                const tooltip = document.getElementById('barTooltip');
                svg.innerHTML = '';
                
                const w = svg.clientWidth || 600;
                const h = svg.clientHeight || 250;
                const pad = 30;
                const max = Math.max(...data.map(d => d.sales)) || 1;
                const barW = ((w - pad*2) / data.length) - 10;

                data.forEach((b, i) => {
                    const hBar = (b.sales / max) * (h - pad*2);
                    const x = pad + i * ((w - pad*2) / data.length);
                    const y = h - pad - hBar;
                    
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", x); rect.setAttribute("y", y);
                    rect.setAttribute("width", barW); rect.setAttribute("height", hBar);
                    rect.setAttribute("fill", "var(--primary)"); rect.setAttribute("rx", 4);
                    rect.style.cursor = "pointer";

                    rect.onmousemove = (e) => {
                        tooltip.style.opacity = 1;
                        tooltip.style.left = (e.pageX + 10) + 'px';
                        tooltip.style.top = (e.pageY - 20) + 'px';
                        tooltip.innerHTML = `<strong>${b.name}</strong><br>$${b.sales.toFixed(0)}`;
                    };
                    rect.onmouseout = () => tooltip.style.opacity = 0;

                    svg.appendChild(rect);
                });
            },

            renderDonutChart: (data) => {
                const svg = document.getElementById('channelChart');
                svg.innerHTML = '';
                
                let totals = {};
                CONFIG.channels.forEach(c => totals[c.id] = 0);
                data.forEach(b => { Object.keys(b.channels).forEach(k => totals[k] += b.channels[k]); });
                
                const total = Object.values(totals).reduce((a,b)=>a+b, 0) || 1;
                let start = 0;
                const cx = 150, cy = 150, r = 100;
                const colors = ['#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ef4444', '#6366f1', '#ec4899', '#14b8a6'];

                CONFIG.channels.forEach((c, i) => {
                    const val = totals[c.id];
                    if(val <= 0) return;
                    const slice = (val/total) * Math.PI * 2;
                    const end = start + slice;
                    
                    const x1 = cx + r * Math.cos(start);
                    const y1 = cy + r * Math.sin(start);
                    const x2 = cx + r * Math.cos(end);
                    const y2 = cy + r * Math.sin(end);
                    
                    const large = slice > Math.PI ? 1 : 0;
                    const pathData = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`;
                    
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", pathData); path.setAttribute("fill", colors[i]);
                    path.setAttribute("stroke", "var(--bg-card)");
                    svg.appendChild(path);
                    start = end;
                });
                // Hole
                const hole = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                hole.setAttribute("cx", cx); hole.setAttribute("cy", cy); hole.setAttribute("r", 60); hole.setAttribute("fill", "var(--bg-card)");
                svg.appendChild(hole);
            },

            renderTables: (branches) => {
                const tb = document.querySelector('#branchTable tbody');
                const tbFull = document.querySelector('#fullBranchTable tbody');
                const cur = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);

                const html = branches.map(b => `
                    <tr>
                        <td style="font-weight:600;">${b.name}</td>
                        <td class="num">${cur(b.sales)}</td>
                        <td class="num">${b.trn}</td>
                        <td class="num">${cur(b.avg)}</td>
                    </tr>
                `).join('');
                
                if(tb) tb.innerHTML = html;
                if(tbFull) tbFull.innerHTML = html;
            },

            populateSelects: () => {
                const fill = (id) => {
                    const sel = document.getElementById(id);
                    if(!sel) return;
                    sel.innerHTML = '<option value="all">All Branches</option>';
                    CONFIG.branches.forEach(b => sel.innerHTML += `<option value="${b}">${b}</option>`);
                };
                fill('branchSelector');
                fill('entryBranchSelect');
            },

            filterBranch: (val) => {
                state.activeFilter = val;
                state.activeBranchIdx = val === 'all' ? 0 : CONFIG.branches.indexOf(val);
                app.renderNav();
                app.updatePeriod();
            },

            renderNav: () => {
                const list = document.getElementById('navList');
                list.innerHTML = '';
                CONFIG.branches.forEach((b, i) => {
                    const el = document.createElement('div');
                    el.className = `nav-item ${i===state.activeBranchIdx ? 'active' : ''}`;
                    el.innerHTML = `<i class="fas fa-store"></i> <span>${b}</span>`;
                    el.onclick = () => {
                        state.activeBranchIdx = i;
                        state.activeFilter = b;
                        document.getElementById('branchSelector').value = b;
                        app.renderNav();
                        app.updatePeriod();
                    };
                    list.appendChild(el);
                });
            },
            
            changeEntryBranch: (val) => {
                state.activeBranchIdx = CONFIG.branches.indexOf(val);
                app.renderNav();
                app.renderEntryTable();
            },

            switchTab: (id) => {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('view-'+id).classList.add('active');
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.target.closest('.tab-btn').classList.add('active');
            },

            toggleTheme: () => document.body.classList.toggle('dark-mode'),
            exportCSV: () => alert('Export functionality ready.')
        };

        window.onload = app.init;
    </script>
</body>
</html>
