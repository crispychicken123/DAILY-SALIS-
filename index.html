<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crispy Chicken - Fixed Analytics</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --primary-color: #b30000;
    --primary-dark: #800000;
    --dark-color: #1d3557;
    --success-color: #2a9d8f;
    --bg-color: #f3f4f6;
    --card-bg: #ffffff;
    --text-main: #1f2937;
    --border-color: #e5e7eb;
    --border-radius: 8px;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; padding-bottom: 40px; }

/* Typography & Utilities */
.num-font { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
.text-right { text-align: right; }
.font-bold { font-weight: 700; }
.hidden { display: none !important; }

/* Layout */
.container { max-width: 1900px; margin: 0 auto; padding: 20px; }
.grid-main { display: grid; grid-template-columns: 400px 1fr; gap: 24px; }
.grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 24px; }

@media (max-width: 1200px) { .grid-main { grid-template-columns: 1fr; } }

header {
    background: var(--card-bg); padding: 15px 25px; border-radius: var(--border-radius);
    margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 4px solid var(--primary-color);
}
h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 10px; color: var(--primary-color); }

/* Buttons */
.btn {
    padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;
    font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px;
}
.btn-primary { background: var(--primary-color); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: white; border: 1px solid var(--border-color); }
.btn-danger { background: #e76f51; color: white; }
.btn-sm { padding: 4px 10px; font-size: 0.8rem; }

/* Cards */
.card {
    background: var(--card-bg); border-radius: var(--border-radius);
    padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    margin-bottom: 20px;
}
.card-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
.card-title { font-weight: 700; display: flex; align-items: center; gap: 8px; }

/* Entry Form (Report Style) */
.entry-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;
}
.entry-row {
    display: grid; grid-template-columns: 1fr 80px 80px; gap: 10px; align-items: center;
    margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px;
}
.entry-label { font-size: 0.85rem; font-weight: 600; color: var(--dark-color); }
.entry-input { 
    padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; 
    font-size: 0.9rem; width: 100%;
}
.entry-input:focus { border-color: var(--primary-color); outline: none; }
.date-range-display {
    background: #f0f9ff; border: 1px solid #bae6fd; padding: 10px; 
    border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; color: #0c4a6e; display: flex; justify-content: space-between;
}

/* Filters */
.filter-bar { background: white; padding: 10px; border-radius: 6px; display: flex; gap: 10px; margin-bottom: 10px; align-items: center; border: 1px solid #eee; }
.filter-select { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }

/* Tables */
.table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 6px; max-height: 600px; }
.main-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 800px; }
.main-table th {
    background: #f8fafc; padding: 12px 15px; text-align: left; font-weight: 700;
    border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 10;
}
.main-table td { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
.main-table tr:hover { background-color: #f9fafb; }
.col-right { text-align: right; }

/* Performance Ranking */
.rank-badge { width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.75rem; }
.r-1 { background: #FFD700; } .r-2 { background: #C0C0C0; } .r-3 { background: #CD7F32; }

/* Modal */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;
    display: none; align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }

/* Toast */
.toast {
    position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 20px;
    border-radius: 6px; transform: translateY(100px); transition: 0.3s; z-index: 2000; display: flex; gap: 10px;
}
.toast.show { transform: translateY(0); }
</style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-drumstick-bite"></i> Crispy Chicken <span style="font-size:0.8em; font-weight:400; color:#666;">| Analytics</span></h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('csvInput').click()"><i class="fas fa-file-import"></i> Import</button>
            <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="importCSV(this)">
            <button class="btn btn-secondary btn-sm" onclick="exportCSV()"><i class="fas fa-download"></i> Export</button>
        </div>
    </header>

    <!-- KPI -->
    <div class="grid-kpi">
        <div class="card">
            <div style="font-size:0.8rem; color:#666; font-weight:600; text-transform:uppercase;">Total Sales</div>
            <div class="num-font font-bold" style="font-size:1.8rem; color:var(--primary-color);" id="kpi-sales">AED 0</div>
            <div id="kpi-count" style="font-size:0.8rem;">0 Records</div>
        </div>
        <div class="card">
            <div style="font-size:0.8rem; color:#666; font-weight:600; text-transform:uppercase;">Target Achievement</div>
            <div class="num-font font-bold" style="font-size:1.8rem; color:var(--dark-color);" id="kpi-ach">0%</div>
            <div id="kpi-target" style="font-size:0.8rem;">Target: 0</div>
        </div>
        <div class="card">
            <div style="font-size:0.8rem; color:#666; font-weight:600; text-transform:uppercase;">Total Transactions</div>
            <div class="num-font font-bold" style="font-size:1.8rem; color:var(--success-color);" id="kpi-trans">0</div>
            <div id="kpi-avg" style="font-size:0.8rem;">Avg Ticket: 0</div>
        </div>
    </div>

    <div class="grid-main">
        <!-- LEFT: ENTRY FORM -->
        <aside>
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-edit"></i> Report Entry</div>
                </div>
                <form id="quickForm" onsubmit="handleQuickSubmit(event)">
                    
                    <!-- Date Range -->
                    <div class="date-range-display">
                        <span><i class="far fa-calendar-alt"></i> Period:</span>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <input type="date" id="q_date_start" required onchange="updateDateDisplay(); calcTarget()">
                            <span>to</span>
                            <input type="date" id="q_date_end" required onchange="updateDateDisplay(); calcTarget()">
                        </div>
                    </div>

                    <select id="q_branch" class="entry-input" style="margin-bottom:10px;" required onchange="calcTarget()">
                        <option value="">Select Branch...</option>
                    </select>
                    
                    <div style="margin-bottom:15px; background:#f9fafb; padding:10px; border-radius:6px;">
                        <label style="font-size:0.75rem; font-weight:bold; color:#666; display:block; margin-bottom:5px;">Calculated Target</label>
                        <input type="text" id="q_target" class="entry-input" readonly style="background:#fff; color:#065f46; font-weight:bold; text-align:right;">
                    </div>

                    <!-- Channel Inputs (Report Style) -->
                    <div style="font-size:0.75rem; font-weight:bold; color:#666; margin-bottom:5px; text-transform:uppercase;">Channel Details</div>
                    
                    <!-- Delivery -->
                    <div class="entry-row">
                        <div class="entry-label"><i class="fas fa-motorcycle" style="color:#b30000;"></i> Delivery</div>
                        <input type="number" step="0.01" id="q_delivery" placeholder="Sales" class="entry-input calc-trigger">
                        <input type="number" id="q_delivery_trans" placeholder="Trx" class="entry-input calc-trigger">
                    </div>
                    <!-- Online -->
                    <div class="entry-row">
                        <div class="entry-label"><i class="fas fa-laptop" style="color:#e63946;"></i> Online</div>
                        <input type="number" step="0.01" id="q_online" placeholder="Sales" class="entry-input calc-trigger">
                        <input type="number" id="q_online_trans" placeholder="Trx" class="entry-input calc-trigger">
                    </div>
                    <!-- Aggregator -->
                    <div class="entry-row">
                        <div class="entry-label"><i class="fas fa-store" style="color:#457b9d;"></i> Aggregator</div>
                        <input type="number" step="0.01" id="q_aggregator" placeholder="Sales" class="entry-input calc-trigger">
                        <input type="number" id="q_aggregator_trans" placeholder="Trx" class="entry-input calc-trigger">
                    </div>
                    <!-- Dining -->
                    <div class="entry-row" style="border-bottom:none;">
                        <div class="entry-label"><i class="fas fa-utensils" style="color:#e9c46a;"></i> Dining</div>
                        <input type="number" step="0.01" id="q_dining" placeholder="Sales" class="entry-input calc-trigger">
                        <input type="number" id="q_dining_trans" placeholder="Trx" class="entry-input calc-trigger">
                    </div>

                    <!-- Totals Preview -->
                    <div style="background:#e0f2fe; padding:10px; border-radius:6px; margin-top:10px; display:flex; justify-content:space-between; border:1px solid #7dd3fc;">
                        <div>
                            <div style="font-size:0.7rem; font-weight:bold; color:#0369a1;">TOTAL SALES</div>
                            <div style="font-weight:800; color:#0c4a6e;" id="preview_sales">AED 0.00</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.7rem; font-weight:bold; color:#0369a1;">TOTAL TRX</div>
                            <div style="font-weight:800; color:#0c4a6e;" id="preview_trans">0</div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center; margin-top:15px;">
                        <i class="fas fa-save"></i> Save Report
                    </button>
                </form>
            </div>
        </aside>

        <!-- RIGHT: DASHBOARD -->
        <main>
            <!-- Filters -->
            <div class="filter-bar">
                <div style="font-weight:bold; font-size:0.9rem;"><i class="fas fa-filter"></i> View:</div>
                <select id="f_branch" class="filter-select" onchange="updateDashboard()"><option value="all">All Branches</option></select>
                <select id="f_mode" class="filter-select" onchange="toggleFilterInputs()">
                    <option value="range">Recent Range</option>
                    <option value="month">Specific Month</option>
                </select>
                <select id="f_range" class="filter-select" onchange="updateDashboard()">
                    <option value="today">Today</option>
                    <option value="week" selected>Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                    <option value="all">All Time</option>
                </select>
                <input type="month" id="f_month" class="filter-select" style="display:none;" onchange="updateDashboard()">
            </div>

            <!-- Ranking -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-trophy" style="color:#FFD700;"></i> Branch Performance Ranking</div>
                </div>
                <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:20px;">
                    <div style="overflow-x:auto;">
                        <table class="main-table" style="min-width:auto;">
                            <thead>
                                <tr>
                                    <th style="width:40px;">#</th>
                                    <th>Branch</th>
                                    <th class="col-right">Target</th>
                                    <th class="col-right">Actual</th>
                                    <th class="col-right">Ach %</th>
                                </tr>
                            </thead>
                            <tbody id="rankBody"></tbody>
                        </table>
                    </div>
                    <div style="height:250px; position:relative;">
                        <canvas id="perfChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- History Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-list"></i> Transaction History</div>
                </div>
                <div class="table-container">
                    <table class="main-table">
                        <thead>
                            <tr>
                                <th width="120">Date (Range)</th>
                                <th>Branch</th>
                                <th class="col-right">Del. (S/T)</th>
                                <th class="col-right">On. (S/T)</th>
                                <th class="col-right">Agg. (S/T)</th>
                                <th class="col-right">Din. (S/T)</th>
                                <th class="col-right" style="border-left:2px solid #eee;">Total Sales</th>
                                <th class="col-right">Total Trx</th>
                                <th class="col-right">Ach %</th>
                                <th class="col-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div id="emptyState" style="text-align:center; padding:30px; color:#999; display:none;">
                    <i class="fas fa-search" style="font-size:2rem; margin-bottom:10px;"></i>
                    <p>No records found for the selected filter.</p>
                </div>
            </div>
        </main>
    </div>
</div>

<div class="toast" id="toast"><i class="fas fa-check-circle"></i> <span id="toastMsg">Saved</span></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- CONFIG ---
const STORAGE_KEY = 'crispy_fixed_v2';
let salesData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let charts = {};

const BRANCH_TARGETS = {
    "Crispy Chicken Hamdan": 840000,
    "Crispy Chicken Shabiya": 800000,
    "Crispy Chicken Khaldia": 750000,
    "Crispy Chicken Muroor": 620000,
    "Crispy Chicken Al Barsha": 800000,
    "Crispy Chicken Al Satwa": 650000,
    "Crispy Chicken ELctria": 1000000,
    "Crispy Chicken Al Rgga": 815000,
    "Crispy Chicken Majaz": 400000,
    "Crispy Chicken Call Center": 265000
};

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('q_date_start').value = today;
    document.getElementById('q_date_end').value = today;
    updateDateDisplay();

    // Populate Branches
    Object.keys(BRANCH_TARGETS).forEach(b => {
        ['q_branch', 'f_branch'].forEach(id => {
            const opt = document.createElement('option'); opt.value = b;
            opt.textContent = b.replace('Crispy Chicken ', '');
            document.getElementById(id).appendChild(opt);
        });
    });

    // Listeners
    document.querySelectorAll('.calc-trigger').forEach(el => el.addEventListener('input', updatePreview));
    
    initCharts();
    updateDashboard();
});

// --- UI LOGIC ---
function toggleFilterInputs() {
    const mode = document.getElementById('f_mode').value;
    document.getElementById('f_range').style.display = mode === 'range' ? 'block' : 'none';
    document.getElementById('f_month').style.display = mode === 'month' ? 'block' : 'none';
    updateDashboard();
}

function updateDateDisplay() {
    // Just visual feedback, optional
    calcTarget();
}

function updatePreview() {
    let s=0, t=0;
    ['delivery','online','aggregator','dining'].forEach(c => {
        s += parseFloat(document.getElementById(`q_${c}`).value)||0;
        t += parseFloat(document.getElementById(`q_${c}_trans`).value)||0;
    });
    document.getElementById('preview_sales').textContent = `AED ${s.toLocaleString(undefined, {minimumFractionDigits:2})}`;
    document.getElementById('preview_trans').textContent = t;
}

// --- CORE LOGIC ---
function calcTarget() {
    const branch = document.getElementById('q_branch').value;
    const sDate = document.getElementById('q_date_start').value;
    const eDate = document.getElementById('q_date_end').value;
    const out = document.getElementById('q_target');

    if(!branch || !sDate || !eDate) { out.value = 0; return; }
    
    let start = new Date(sDate), end = new Date(eDate);
    if(start > end) { out.value = "Invalid Range"; return; }

    let total = 0, curr = new Date(start);
    const monthTgt = BRANCH_TARGETS[branch];

    while(curr <= end) {
        const daysInMonth = new Date(curr.getFullYear(), curr.getMonth()+1, 0).getDate();
        total += monthTgt / daysInMonth;
        curr.setDate(curr.getDate()+1);
    }
    out.value = total.toFixed(2);
}

function getFilteredData() {
    const fBranch = document.getElementById('f_branch').value;
    const fMode = document.getElementById('f_mode').value;
    
    return salesData.filter(item => {
        // Normalize Dates to Strings YYYY-MM-DD
        // Support old data (single 'date') and new data ('date_start')
        const itemDate = (item.date_start || item.date).split('T')[0]; 
        
        // Branch Filter
        if(fBranch !== 'all' && item.branch !== fBranch) return false;

        // Date Filter
        if(fMode === 'month') {
            const mVal = document.getElementById('f_month').value; // "2023-10"
            if(!mVal) return false;
            return itemDate.startsWith(mVal);
        } else {
            const range = document.getElementById('f_range').value;
            const todayStr = new Date().toISOString().split('T')[0];
            let cutoff = new Date();
            cutoff.setHours(0,0,0,0); // Local Midnight
            
            if(range === 'today') cutoff.setDate(new Date().getDate() - 1);
            if(range === 'week') cutoff.setDate(new Date().getDate() - 7);
            if(range === 'month') cutoff.setDate(new Date().getDate() - 30);
            if(range === 'all') cutoff = new Date('2020-01-01');
            
            const cutoffStr = cutoff.toISOString().split('T')[0];
            
            // Logic: Is Item Start Date within the cutoff range?
            return itemDate >= cutoffStr && itemDate <= todayStr;
        }
    }).sort((a,b) => new Date(b.date_start || b.date) - new Date(a.date_start || a.date));
}

function updateDashboard() {
    const data = getFilteredData();
    renderKPI(data);
    renderRanking(data);
    renderTable(data);
}

// --- RENDER ---
function renderKPI(data) {
    const totalS = data.reduce((s,i)=>s+i.total,0);
    const totalT = data.reduce((s,i)=>s+i.total_trans,0);
    const totalTgt = data.reduce((s,i)=>s+i.target,0);
    const ach = totalTgt ? ((totalS/totalTgt)*100).toFixed(1) : 0;
    const avg = totalT ? (totalS/totalT).toFixed(1) : 0;

    document.getElementById('kpi-sales').textContent = `AED ${totalS.toLocaleString()}`;
    document.getElementById('kpi-count').textContent = `${data.length} Records`;
    document.getElementById('kpi-ach').textContent = `${ach}%`;
    document.getElementById('kpi-target').textContent = `Target: ${totalTgt.toLocaleString()}`;
    document.getElementById('kpi-trans').textContent = totalT.toLocaleString();
    document.getElementById('kpi-avg').textContent = `Avg Ticket: ${avg}`;
}

function renderRanking(data) {
    const stats = {};
    Object.keys(BRANCH_TARGETS).forEach(b => stats[b] = { s:0, t:0 });
    
    data.forEach(i => {
        if(!stats[i.branch]) stats[i.branch] = {s:0, t:0};
        stats[i.branch].s += i.total;
        stats[i.branch].t += i.target;
    });

    const ranked = Object.keys(stats).map(b => ({
        name: b.replace('Crispy Chicken ',''), 
        s: stats[b].s, t: stats[b].t,
        ach: stats[b].t ? ((stats[b].s/stats[b].t)*100).toFixed(1) : 0
    })).sort((a,b) => parseFloat(b.ach) - parseFloat(a.ach));

    document.getElementById('rankBody').innerHTML = ranked.map((r,i) => `
        <tr>
            <td><span class="rank-badge r-${i+1}">${i+1}</span></td>
            <td>${r.name}</td>
            <td class="col-right num-font">${r.t.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
            <td class="col-right num-font font-bold">${r.s.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
            <td class="col-right font-bold">${r.ach}%</td>
        </tr>
    `).join('');

    // Update Chart
    charts.perf.data.labels = ranked.map(r=>r.name);
    charts.perf.data.datasets = [
        { label:'Target', data: ranked.map(r=>r.t), backgroundColor:'#e2e8f0', borderRadius:4 },
        { label:'Actual', data: ranked.map(r=>r.s), backgroundColor:'#b30000', borderRadius:4 }
    ];
    charts.perf.update();
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    const table = document.getElementById('dataTable');
    const empty = document.getElementById('emptyState');

    if(data.length === 0) {
        tbody.innerHTML = ''; 
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    tbody.innerHTML = data.map(item => {
        const ach = item.target ? Math.round((item.total/item.target)*100) : 0;
        const color = ach>=100?'var(--success-color)':(ach<80?'#e76f51':'#e9c46a');
        
        // Format Date
        const s = item.date_start || item.date;
        const e = item.date_end || item.date;
        const display = s===e ? s : `${s} - ${e}`;

        return `
        <tr>
            <td style="font-size:0.8rem;">${display}</td>
            <td>${item.branch.replace('Crispy Chicken ','')}</td>
            <td class="col-right">${item.delivery}<br><small style="color:#888">${item.delivery_trans}</small></td>
            <td class="col-right">${item.online}<br><small style="color:#888">${item.online_trans}</small></td>
            <td class="col-right">${item.aggregator}<br><small style="color:#888">${item.aggregator_trans}</small></td>
            <td class="col-right">${item.dining}<br><small style="color:#888">${item.dining_trans}</small></td>
            <td class="col-right font-bold" style="border-left:2px solid #eee;">AED ${item.total.toLocaleString()}</td>
            <td class="col-right">${item.total_trans}</td>
            <td class="col-right"><span style="color:${color}; font-weight:bold;">${ach}%</span></td>
            <td class="col-right">
                <button class="btn btn-secondary btn-sm" onclick="edit(${item.id})"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger btn-sm" onclick="del(${item.id})"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');
}

// --- FORMS ---
function handleQuickSubmit(e) {
    e.preventDefault();
    const f = (id) => parseFloat(document.getElementById(id).value) || 0;
    const d_s = f('q_delivery'), d_t = f('q_delivery_trans');
    const o_s = f('q_online'), o_t = f('q_online_trans');
    const a_s = f('q_aggregator'), a_t = f('q_aggregator_trans');
    const di_s = f('q_dining'), di_t = f('q_dining_trans');

    const entry = {
        id: Date.now(),
        branch: document.getElementById('q_branch').value,
        date_start: document.getElementById('q_date_start').value,
        date_end: document.getElementById('q_date_end').value,
        target: f('q_target'),
        delivery: d_s, delivery_trans: d_t,
        online: o_s, online_trans: o_t,
        aggregator: a_s, aggregator_trans: a_t,
        dining: di_s, dining_trans: di_t,
        total: d_s+o_s+a_s+di_s,
        total_trans: d_t+o_t+a_t+di_t
    };

    salesData.push(entry);
    save();
    e.target.reset();
    // Reset dates to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('q_date_start').value = today;
    document.getElementById('q_date_end').value = today;
    updateDateDisplay();
    showToast('Saved!');
}

function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(salesData));
    updateDashboard();
}

function del(id) { if(confirm('Delete?')) { salesData = salesData.filter(i=>i.id!==id); save(); } }
function edit(id) { alert("Edit functionality in quick form not available, please delete and re-enter."); } 

// --- CHARTS ---
function initCharts() {
    const ctx = document.getElementById('perfChart').getContext('2d');
    charts.perf = new Chart(ctx, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true } } }
    });
}

function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

// --- CSV ---
function exportCSV() {
    if(!salesData.length) return showToast('No data');
    const h = ['ID,Branch,Start,End,Delivery,DelTrx,Online,OnTrx,Agg,AggTrx,Dining,DinTrx,Total,Trx,Target'];
    const rows = salesData.map(d => 
        `${d.id},"${d.branch}",${d.date_start||d.date},${d.date_end||d.date},${d.delivery},${d.delivery_trans},${d.online},${d.online_trans},${d.aggregator},${d.aggregator_trans},${d.dining},${d.dining_trans},${d.total},${d.total_trans},${d.target}`
    );
    const blob = new Blob(["\uFEFF"+h.concat(rows).join('\n')], {type:'text/csv'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='data.csv'; a.click();
}

function importCSV(inp) {
    const reader = new FileReader();
    reader.onload = function(e){
        const rows = e.target.result.split('\n').slice(1);
        let c=0;
        rows.forEach(r=>{
            if(!r.trim()) return;
            const cols = r.split(',').map(s=>s.replace(/"/g,'').trim());
            if(cols.length > 10) {
                salesData.push({
                    id: parseInt(cols[0])||Date.now()+c,
                    branch: cols[1],
                    date_start: cols[2]||cols[1],
                    date_end: cols[3]||cols[1],
                    delivery: parseFloat(cols[4])||0, delivery_trans: parseFloat(cols[5])||0,
                    online: parseFloat(cols[6])||0, online_trans: parseFloat(cols[7])||0,
                    aggregator: parseFloat(cols[8])||0, aggregator_trans: parseFloat(cols[9])||0,
                    dining: parseFloat(cols[10])||0, dining_trans: parseFloat(cols[11])||0,
                    total: parseFloat(cols[12])||0, total_trans: parseFloat(cols[13])||0,
                    target: parseFloat(cols[14])||0
                });
                c++;
            }
        });
        save(); showToast('Imported '+c);
    };
    reader.readAsText(inp.files[0]);
}
</script>
</body>
</html>
