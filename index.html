<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crispy Chicken - Ultimate Analytics</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --primary-color: #b30000;
    --primary-dark: #800000;
    --secondary-color: #e63946;
    --dark-color: #1d3557;
    --success-color: #2a9d8f;
    --warning-color: #e9c46a;
    --danger-color: #e76f51;
    --info-color: #457b9d;
    --bg-color: #f3f4f6;
    --card-bg: #ffffff;
    --text-main: #1f2937;
    --text-muted: #6b7280;
    --border-color: #e5e7eb;
    --border-radius: 10px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; padding-bottom: 40px; }

.num-font { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
.text-right { text-align: right; }
.font-bold { font-weight: 700; }

/* Layout */
.container { max-width: 1900px; margin: 0 auto; padding: 20px; }
.grid-main { display: grid; grid-template-columns: 360px 1fr; gap: 24px; }
.grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
.grid-channels { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }

@media (max-width: 1200px) { .grid-main { grid-template-columns: 1fr; } }
@media (max-width: 768px) { .grid-channels { grid-template-columns: 1fr 1fr; } }

header {
    background: var(--card-bg); padding: 15px 25px; border-radius: var(--border-radius);
    margin-bottom: 24px; box-shadow: var(--shadow-lg);
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    border-bottom: 4px solid var(--primary-color);
}
h1 { font-size: 1.4rem; display: flex; align-items: center; gap: 10px; color: var(--primary-color); }

.btn {
    padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;
    font-size: 0.9rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
}
.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
.btn-primary { background: var(--primary-color); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: white; border: 1px solid var(--border-color); color: var(--text-main); }
.btn-success { background: var(--success-color); color: white; }
.btn-danger { background: var(--danger-color); color: white; }
.btn-sm { padding: 4px 8px; font-size: 0.8rem; }

.card {
    background: var(--card-bg); border-radius: var(--border-radius);
    padding: 20px; box-shadow: var(--shadow); height: 100%; display: flex; flex-direction: column;
}
.card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;
}
.card-title { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }

/* Date Range Input */
.date-range-group { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 10px; }
.date-range-label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 5px; display: block; }
.date-range-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.date-range-inputs input { font-size: 0.9rem; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }

/* Channel Inputs */
.channel-input-group {
    border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;
    background: #fff; transition: 0.2s;
}
.channel-input-group:focus-within { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(179,0,0,0.1); }
.channel-input-group label { font-size: 0.7rem; color: var(--text-muted); font-weight: 700; display: block; margin-bottom: 4px; text-transform: uppercase; }
.channel-input-group input { border: none; background: transparent; padding: 2px 0; font-size: 0.9rem; width: 100%; }
.channel-input-group input:focus { outline: none; }

/* Summary */
.summary-box {
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
    border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px;
    margin-bottom: 24px;
}
.summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
.sum-item {
    background: white; border: 1px solid #f0f0f0; border-radius: 6px; padding: 12px;
    display: flex; flex-direction: column; justify-content: center;
}
.sum-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
.sum-val { font-size: 1.1rem; font-weight: 800; color: var(--text-main); }
.sum-sub { font-size: 0.75rem; color: var(--primary-color); }

/* Tables */
.table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; max-height: 500px; overflow-y: auto; }
.main-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.main-table thead th {
    background: #f8fafc; color: var(--text-muted); padding: 12px 15px; text-align: left; 
    font-size: 0.75rem; text-transform: uppercase; font-weight: 700; border-bottom: 2px solid #e2e8f0;
    position: sticky; top: 0; z-index: 10;
}
.main-table tbody td { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
.main-table tr:hover { background-color: #fcfcfc; }

/* Filter Bar */
.filter-bar { display: flex; gap: 10px; align-items: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 10px; }
.filter-input { padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; }

/* Performance */
.rank-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.rank-table th { background: var(--dark-color); color: white; padding: 10px; text-align: left; font-size: 0.8rem; }
.rank-table td { padding: 10px; border-bottom: 1px solid #eee; }
.rank-badge { width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 0.75rem; }
.rank-1 { background: #FFD700; }
.rank-2 { background: #C0C0C0; }
.rank-3 { background: #CD7F32; }

/* Form */
.form-control { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 10px; }
.form-control:focus { outline: none; border-color: var(--primary-color); }

.live-preview {
    background: #ecfdf5; border: 1px solid #6ee7b7; border-radius: 6px; padding: 10px; margin-top: 15px;
    display: flex; justify-content: space-between; font-size: 0.9rem;
}
.lp-label { color: #065f46; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
.lp-val { color: #065f46; font-weight: 800; font-size: 1rem; }

/* Modal */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
    z-index: 1000; display: flex; align-items: center; justify-content: center;
    opacity: 0; visibility: hidden; transition: 0.2s;
}
.modal-overlay.open { opacity: 1; visibility: visible; }
.modal {
    background: white; width: 95%; max-width: 850px; border-radius: var(--border-radius);
    padding: 25px; box-shadow: var(--shadow-lg); transform: scale(0.95); transition: 0.2s;
    max-height: 90vh; overflow-y: auto;
}
.modal-overlay.open .modal { transform: scale(1); }

/* Toast */
.toast {
    position: fixed; bottom: 20px; right: 20px; z-index: 2000;
    background: #1f2937; color: white; padding: 12px 20px; border-radius: 8px;
    box-shadow: var(--shadow-lg); transform: translateY(100px); transition: 0.3s;
    display: flex; align-items: center; gap: 10px;
}
.toast.show { transform: translateY(0); }
</style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-drumstick-bite"></i> Crispy Chicken <span style="font-weight:400; font-size: 0.9em; color: #666; margin-left:10px;">| Ultimate Analytics</span></h1>
        <div style="display: flex; gap: 10px; align-items: center;">
            <span id="currentDate" style="color:#666; font-size: 0.9rem;"></span>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('csvInput').click()">
                <i class="fas fa-file-import"></i> Import CSV
            </button>
            <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="importCSV(this)">
            <button class="btn btn-secondary btn-sm" onclick="exportCSV()">
                <i class="fas fa-download"></i> Export
            </button>
            <button class="btn btn-primary" onclick="openModal()">
                <i class="fas fa-plus"></i> New Entry
            </button>
        </div>
    </header>

    <!-- KPI & SUMMARY -->
    <div class="grid-kpi">
        <div class="card">
            <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:5px;">Total Sales</div>
            <div class="num-font" style="font-size: 2rem; font-weight:800; color: #111;" id="kpi-total-sales">AED 0</div>
            <div style="font-size:0.8rem; color:#666;" id="kpi-rec-count">0 Records</div>
        </div>
        <div class="card">
            <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:5px;">Transactions</div>
            <div class="num-font" style="font-size: 2rem; font-weight:800; color: #111;" id="kpi-total-trans">0</div>
            <div style="font-size:0.8rem; color:#666;" id="kpi-avg-ticket">Avg: AED 0</div>
        </div>
        <div class="card">
            <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:5px;">Achievement</div>
            <div class="num-font" style="font-size: 2rem; font-weight:800; color: #111;" id="kpi-ach">0%</div>
            <div style="font-size:0.8rem; color:#666;" id="kpi-target-text">Target: AED 0</div>
        </div>
    </div>

    <!-- CHANNEL BREAKDOWN -->
    <div class="summary-box">
        <div style="font-weight:700; color:var(--dark-color); margin-bottom:15px; display:flex; gap:8px;"><i class="fas fa-chart-pie"></i> Channel Breakdown</div>
        <div class="summary-grid" id="channelSummary"></div>
    </div>

    <div class="grid-main">
        <!-- LEFT: ENTRY -->
        <aside>
            <div class="card">
                <div class="card-header"><div class="card-title"><i class="fas fa-edit"></i> Quick Entry</div></div>
                <form id="quickForm" onsubmit="handleQuickSubmit(event)">
                    
                    <!-- Date Range Section -->
                    <div class="date-range-group">
                        <span class="date-range-label"><i class="far fa-calendar-alt"></i> Select Period</span>
                        <div class="date-range-inputs">
                            <input type="date" id="q_date_start" required onchange="calcTarget('q')">
                            <input type="date" id="q_date_end" required onchange="calcTarget('q')">
                        </div>
                    </div>

                    <select id="q_branch" class="form-control" required onchange="calcTarget('q')">
                        <option value="">Select Branch...</option>
                    </select>
                    
                    <input type="text" id="q_target" class="form-control" placeholder="Auto Target..." readonly style="background:#f3f4f6; color:#065f46; font-weight:600; border:1px solid #6ee7b7;">

                    <div style="font-size:0.75rem; color:#666; margin:15px 0 10px 0; text-transform:uppercase; font-weight:700;">Channels (Sales & Trx)</div>
                    
                    <div class="grid-channels" style="gap:10px; margin-bottom: 10px;">
                        <!-- Delivery -->
                        <div class="channel-input-group">
                            <label>Delivery</label>
                            <input type="number" step="0.01" id="q_delivery" placeholder="0.00" class="num-font calc-trigger">
                            <input type="number" id="q_delivery_trans" placeholder="0" class="num-font calc-trigger">
                        </div>
                        <!-- Online -->
                        <div class="channel-input-group">
                            <label>Online</label>
                            <input type="number" step="0.01" id="q_online" placeholder="0.00" class="num-font calc-trigger">
                            <input type="number" id="q_online_trans" placeholder="0" class="num-font calc-trigger">
                        </div>
                        <!-- Aggregator -->
                        <div class="channel-input-group">
                            <label>Aggregator</label>
                            <input type="number" step="0.01" id="q_aggregator" placeholder="0.00" class="num-font calc-trigger">
                            <input type="number" id="q_aggregator_trans" placeholder="0" class="num-font calc-trigger">
                        </div>
                        <!-- Dining -->
                        <div class="channel-input-group">
                            <label>Dining</label>
                            <input type="number" step="0.01" id="q_dining" placeholder="0.00" class="num-font calc-trigger">
                            <input type="number" id="q_dining_trans" placeholder="0" class="num-font calc-trigger">
                        </div>
                    </div>

                    <!-- Live Preview -->
                    <div class="live-preview">
                        <div>
                            <div class="lp-label">Total Sales</div>
                            <div class="lp-val" id="preview_sales">AED 0.00</div>
                        </div>
                        <div style="text-align:right;">
                            <div class="lp-label">Total Trans</div>
                            <div class="lp-val" id="preview_trans">0</div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width:100%; margin-top:15px; justify-content:center;">
                        <i class="fas fa-save"></i> Save Entry
                    </button>
                </form>
            </div>
        </aside>

        <!-- RIGHT: DASHBOARD -->
        <main>
            <!-- Filters -->
            <div class="filter-bar">
                <div style="font-weight:600; font-size:0.9rem; margin-right:10px;"><i class="fas fa-filter"></i> Filter:</div>
                <select id="filterBranch" class="filter-input" onchange="updateDashboard()"><option value="all">All Branches</option></select>
                
                <!-- New Month Filter -->
                <select id="filterMonthType" class="filter-input" onchange="toggleMonthFilter()">
                    <option value="range">Recent Range</option>
                    <option value="month">Specific Month</option>
                </select>
                
                <select id="perfPeriod" class="filter-input" onchange="updateDashboard()">
                    <option value="today">Today</option>
                    <option value="week" selected>Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                    <option value="all">All Time</option>
                </select>

                <!-- Hidden Month Picker -->
                <input type="month" id="monthPicker" class="filter-input" style="display:none;" onchange="updateDashboard()">
            </div>

            <!-- Ranking -->
            <section class="card" style="margin-bottom:24px;">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-trophy"></i> Performance Ranking</div>
                </div>
                <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px;">
                    <div style="overflow-x:auto;">
                        <table class="rank-table">
                            <thead><tr><th>#</th><th>Branch</th><th class="text-right">Target</th><th class="text-right">Actual</th><th class="text-center">Ach %</th></tr></thead>
                            <tbody id="rankBody"></tbody>
                        </table>
                    </div>
                    <div style="height: 200px; position: relative;">
                        <canvas id="perfChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Table -->
            <section class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-list"></i> Transaction History</div>
                </div>
                <div class="table-container">
                    <table class="main-table">
                        <thead>
                            <tr>
                                <th width="120">Period</th>
                                <th width="150">Branch</th>
                                <th class="text-right">Delivery (S/T)</th>
                                <th class="text-right">Online (S/T)</th>
                                <th class="text-right">Agg (S/T)</th>
                                <th class="text-right">Dining (S/T)</th>
                                <th class="text-right" style="border-left:2px solid #eee;">Total Sales</th>
                                <th class="text-right">Trans</th>
                                <th class="text-center">Ach %</th>
                                <th class="text-right" width="60">Act</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div id="emptyState" style="text-align: center; padding: 40px; color: #999; display: none;">
                    <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>No data available</p>
                </div>
            </section>
        </main>
    </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="entryModal">
    <div class="modal">
        <div class="modal-header" style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3 id="modalTitle">Edit Entry</h3>
            <button class="btn btn-secondary btn-sm" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <form id="modalForm" onsubmit="handleModalSubmit(event)">
            <input type="hidden" id="m_id">
            
            <div class="date-range-group">
                <span class="date-range-label">Select Period</span>
                <div class="date-range-inputs">
                    <input type="date" id="m_date_start" required onchange="calcTarget('m')">
                    <input type="date" id="m_date_end" required onchange="calcTarget('m')">
                </div>
            </div>

            <select id="m_branch" class="form-control" required onchange="calcTarget('m')"></select>
            <input type="number" id="m_target" class="form-control" readonly style="background:#f3f4f6; color:#065f46; font-weight:600; border:1px solid #6ee7b7;">
            
            <div class="grid-channels" style="gap:10px; margin-bottom:20px;">
                <div class="channel-input-group">
                    <label>Delivery</label>
                    <input type="number" step="0.01" id="m_delivery" placeholder="Sales" class="num-font">
                    <input type="number" id="m_delivery_trans" placeholder="Trans" class="num-font">
                </div>
                <div class="channel-input-group">
                    <label>Online</label>
                    <input type="number" step="0.01" id="m_online" placeholder="Sales" class="num-font">
                    <input type="number" id="m_online_trans" placeholder="Trans" class="num-font">
                </div>
                <div class="channel-input-group">
                    <label>Aggregator</label>
                    <input type="number" step="0.01" id="m_aggregator" placeholder="Sales" class="num-font">
                    <input type="number" id="m_aggregator_trans" placeholder="Trans" class="num-font">
                </div>
                <div class="channel-input-group">
                    <label>Dining</label>
                    <input type="number" step="0.01" id="m_dining" placeholder="Sales" class="num-font">
                    <input type="number" id="m_dining_trans" placeholder="Trans" class="num-font">
                </div>
            </div>

            <div style="border-top:1px solid #eee; padding-top:15px; display:flex; justify-content:flex-end; gap:10px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<div class="toast" id="toast"><i class="fas fa-check-circle"></i> <span id="toastMsg">Saved</span></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- CONSTANTS & STATE ---
const STORAGE_KEY = 'crispy_ultimate_v1';
let salesData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let charts = {};

const BRANCH_CONFIG = {
    "Crispy Chicken Hamdan": 840000,
    "Crispy Chicken Shabiya": 800000,
    "Crispy Chicken Khaldia": 750000,
    "Crispy Chicken Muroor": 620000,
    "Crispy Chicken Al Barsha": 800000,
    "Crispy Chicken Al Satwa": 650000,
    "Crispy Chicken ELctria": 1000000,
    "Crispy Chicken Al Rgga": 815000,
    "Crispy Chicken Majaz": 400000,
    "Crispy Chicken Call Center": 265000
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    
    // Set defaults to Today
    document.getElementById('q_date_start').value = today;
    document.getElementById('q_date_end').value = today;
    document.getElementById('m_date_start').value = today;
    document.getElementById('m_date_end').value = today;
    
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    // Populate Branches
    const branches = Object.keys(BRANCH_CONFIG);
    ['q_branch', 'm_branch', 'filterBranch'].forEach(id => {
        const sel = document.getElementById(id);
        branches.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b; opt.textContent = b.replace('Crispy Chicken ', '');
            sel.appendChild(opt);
        });
    });

    // Attach Live Calculation
    document.querySelectorAll('.calc-trigger').forEach(el => el.addEventListener('input', updateLivePreview));

    initCharts();
    updateDashboard();
});

function toggleMonthFilter() {
    const type = document.getElementById('filterMonthType').value;
    const rangeSel = document.getElementById('perfPeriod');
    const monthPicker = document.getElementById('monthPicker');

    if (type === 'month') {
        rangeSel.style.display = 'none';
        monthPicker.style.display = 'block';
    } else {
        rangeSel.style.display = 'block';
        monthPicker.style.display = 'none';
    }
    updateDashboard();
}

// --- CORE LOGIC ---

function calcTarget(prefix) {
    const branch = document.getElementById(`${prefix}_branch`).value;
    const startStr = document.getElementById(`${prefix}_date_start`).value;
    const endStr = document.getElementById(`${prefix}_date_end`).value;
    const targetInput = document.getElementById(`${prefix}_target`);

    if (!branch || !startStr || !endStr) {
        targetInput.value = 0;
        return;
    }

    const startDate = new Date(startStr);
    const endDate = new Date(endStr);
    
    // Ensure start <= end
    if (startDate > endDate) {
        targetInput.value = "Invalid Dates";
        return;
    }

    const monthlyTarget = BRANCH_CONFIG[branch];
    let totalTarget = 0;
    let current = new Date(startDate);

    // Calculate weighted target for every day in range
    while (current <= endDate) {
        const year = current.getFullYear();
        const month = current.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        totalTarget += (monthlyTarget / daysInMonth);
        current.setDate(current.getDate() + 1);
    }

    targetInput.value = totalTarget.toFixed(2);
}

function updateLivePreview() {
    let totalSales = 0, totalTrans = 0;
    ['delivery', 'online', 'aggregator', 'dining'].forEach(ch => {
        totalSales += parseFloat(document.getElementById(`q_${ch}`).value) || 0;
        totalTrans += parseFloat(document.getElementById(`q_${ch}_trans`).value) || 0;
    });
    document.getElementById('preview_sales').textContent = `AED ${totalSales.toLocaleString(undefined, {minimumFractionDigits:2})}`;
    document.getElementById('preview_trans').textContent = totalTrans;
}

function getFormData(prefix) {
    const val = (id) => parseFloat(document.getElementById(id).value) || 0;
    
    const d_s = val(`${prefix}_delivery`), d_t = val(`${prefix}_delivery_trans`);
    const o_s = val(`${prefix}_online`), o_t = val(`${prefix}_online_trans`);
    const a_s = val(`${prefix}_aggregator`), a_t = val(`${prefix}_aggregator_trans`);
    const di_s = val(`${prefix}_dining`), di_t = val(`${prefix}_dining_trans`);

    return {
        id: document.getElementById(`${prefix}_id`).value ? parseInt(document.getElementById(`${prefix}_id`).value) : Date.now(),
        branch: document.getElementById(`${prefix}_branch`).value,
        date_start: document.getElementById(`${prefix}_date_start`).value,
        date_end: document.getElementById(`${prefix}_date_end`).value,
        target: val(`${prefix}_target`),
        // Sales
        delivery: d_s, online: o_s, aggregator: a_s, dining: di_s, total: d_s + o_s + a_s + di_s,
        // Transactions
        delivery_trans: d_t, online_trans: o_t, aggregator_trans: a_t, dining_trans: di_t, total_trans: d_t + o_t + a_t + di_t
    };
}

function getFilteredData() {
    const filterType = document.getElementById('filterMonthType').value;
    const branchFilter = document.getElementById('filterBranch').value;
    
    let filtered = salesData.filter(item => {
        const branchMatch = branchFilter === 'all' || item.branch === branchFilter;
        if (!branchMatch) return false;

        // Legacy support: if only 'date' exists (old format), map to date_start and date_end
        const itemStart = new Date(item.date_start || item.date);
        const itemEnd = new Date(item.date_end || item.date);
        itemStart.setHours(0,0,0,0); itemEnd.setHours(23,59,59,999);

        if (filterType === 'month') {
            const monthVal = document.getElementById('monthPicker').value; // "2023-12"
            if (!monthVal) return false;
            const [y, m] = monthVal.split('-');
            const checkDate = new Date(y, m-1, 1);
            return itemStart.getMonth() === checkDate.getMonth() && itemStart.getFullYear() === checkDate.getFullYear();
        } else {
            const period = document.getElementById('perfPeriod').value;
            const today = new Date(); today.setHours(23,59,59,999);
            let cutoff = new Date(today); cutoff.setHours(0,0,0,0);

            if (period === 'today') cutoff = new Date(today);
            if (period === 'week') cutoff.setDate(today.getDate() - 7);
            if (period === 'month') cutoff.setDate(today.getDate() - 30);
            if (period === 'all') cutoff = new Date('2020-01-01');

            // Check if the entry period overlaps with the filter period
            // Simple logic: Does the entry START date fall within the range? 
            // (Or does it overlap? Let's stick to Start Date for simplicity in this view)
            return itemStart >= cutoff && itemStart <= today;
        }
    });

    // Sort by Start Date Descending
    return filtered.sort((a, b) => new Date(b.date_start || b.date) - new Date(a.date_start || a.date));
}

function updateDashboard() {
    const data = getFilteredData();
    renderKPIs(data);
    renderTable(data);
    renderPerformanceBoard(data);
    updatePerfChart(data);
}

// --- RENDER FUNCTIONS ---

function renderKPIs(data) {
    const totalSales = data.reduce((sum, i) => sum + i.total, 0);
    const totalTrans = data.reduce((sum, i) => sum + i.total_trans, 0);
    const totalTarget = data.reduce((sum, i) => sum + i.target, 0);
    const ach = totalTarget ? ((totalSales / totalTarget) * 100).toFixed(1) : 0;
    const avgTicket = totalTrans ? (totalSales / totalTrans).toFixed(1) : 0;

    document.getElementById('kpi-total-sales').textContent = `AED ${totalSales.toLocaleString(undefined, {maximumFractionDigits:0})}`;
    document.getElementById('kpi-total-trans').textContent = totalTrans.toLocaleString();
    document.getElementById('kpi-ach').textContent = `${ach}%`;
    document.getElementById('kpi-avg-ticket').textContent = `Avg: AED ${avgTicket}`;
    document.getElementById('kpi-target-text').textContent = `Target: AED ${totalTarget.toLocaleString(undefined, {maximumFractionDigits:0})}`;
    document.getElementById('kpi-rec-count').textContent = `${data.length} Records`;

    // Channels
    const channels = ['delivery', 'online', 'aggregator', 'dining'];
    const container = document.getElementById('channelSummary');
    container.innerHTML = '';
    channels.forEach(ch => {
        const sales = data.reduce((sum, i) => sum + i[ch], 0);
        const trans = data.reduce((sum, i) => sum + i[`${ch}_trans`], 0);
        container.innerHTML += `
        <div class="sum-item">
            <div class="sum-label">${ch.charAt(0).toUpperCase() + ch.slice(1)}</div>
            <div class="sum-val num-font">AED ${sales.toLocaleString()}</div>
            <div class="sum-sub">${trans} Trx</div>
        </div>`;
    });
}

function renderPerformanceBoard(data) {
    const stats = {};
    Object.keys(BRANCH_CONFIG).forEach(b => stats[b] = { sales: 0, target: 0 });
    
    data.forEach(i => {
        if (!stats[i.branch]) stats[i.branch] = { sales: 0, target: 0 };
        stats[i.branch].sales += i.total;
        stats[i.branch].target += i.target;
    });

    const rankings = Object.keys(stats).map(b => {
        const s = stats[b];
        const ach = s.target ? (s.sales / s.target) * 100 : 0;
        return { name: b.replace('Crispy Chicken ', ''), sales: s.sales, target: s.target, ach: ach.toFixed(1) };
    }).sort((a, b) => parseFloat(b.ach) - parseFloat(a.ach));

    const tbody = document.getElementById('rankBody');
    tbody.innerHTML = rankings.map((r, i) => `
        <tr>
            <td><span class="rank-badge rank-${i+1}">${i+1}</span></td>
            <td><strong>${r.name}</strong></td>
            <td class="text-right num-font">${r.target.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
            <td class="text-right num-font" style="color:var(--primary-color)">${r.sales.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
            <td class="text-center font-bold">${r.ach}%</td>
        </tr>
    `).join('');
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    const table = document.getElementById('dataTable');
    const empty = document.getElementById('emptyState');

    if (data.length === 0) {
        tbody.innerHTML = ''; table.style.display = 'none'; empty.style.display = 'block'; return;
    }
    
    table.style.display = 'table'; empty.style.display = 'none';
    
    tbody.innerHTML = data.map(item => {
        const ach = item.target ? Math.round((item.total / item.target) * 100) : 0;
        const achColor = ach >= 100 ? 'var(--success-color)' : (ach < 80 ? 'var(--danger-color)' : 'var(--warning-color)');
        const fmt = (n) => n.toLocaleString();

        // Date formatting
        const sDate = new Date(item.date_start || item.date);
        const eDate = new Date(item.date_end || item.date);
        const isRange = sDate.getTime() !== eDate.getTime();
        const dateDisplay = isRange 
            ? `${sDate.getDate()}/${sDate.getMonth()+1} - ${eDate.getDate()}/${eDate.getMonth()+1}`
            : `${sDate.getDate()}/${sDate.getMonth()+1}/${sDate.getFullYear()}`;

        return `
        <tr>
            <td style="font-size:0.85rem;">${dateDisplay}</td>
            <td><span style="font-weight:600;">${item.branch.replace('Crispy Chicken ', '')}</span></td>
            <td class="text-right num-font">
                <div>${fmt(item.delivery)}</div>
                <div style="font-size:0.8em; color:#888;">${item.delivery_trans}</div>
            </td>
            <td class="text-right num-font">
                <div>${fmt(item.online)}</div>
                <div style="font-size:0.8em; color:#888;">${item.online_trans}</div>
            </td>
            <td class="text-right num-font">
                <div>${fmt(item.aggregator)}</div>
                <div style="font-size:0.8em; color:#888;">${item.aggregator_trans}</div>
            </td>
            <td class="text-right num-font">
                <div>${fmt(item.dining)}</div>
                <div style="font-size:0.8em; color:#888;">${item.dining_trans}</div>
            </td>
            <td class="text-right num-font" style="border-left:2px solid #eee; font-weight: bold; color:#111;">AED ${fmt(item.total)}</td>
            <td class="text-right num-font">${item.total_trans}</td>
            <td class="text-center"><span style="color:${achColor}; font-weight:700; padding:2px 6px; background:${achColor}20; border-radius:4px;">${ach}%</span></td>
            <td class="text-right">
                <button class="btn btn-secondary btn-sm" onclick="openEdit(${item.id})"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger btn-sm" onclick="deleteEntry(${item.id})"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');
}

// --- ACTIONS ---

function handleQuickSubmit(e) {
    e.preventDefault();
    const entry = getFormData('q');
    entry.id = Date.now();
    salesData.push(entry);
    saveData();
    showToast('Entry Added');
    
    // Reset but keep dates
    const sDate = document.getElementById('q_date_start').value;
    const eDate = document.getElementById('q_date_end').value;
    const branch = document.getElementById('q_branch').value;
    e.target.reset();
    document.getElementById('q_date_start').value = sDate;
    document.getElementById('q_date_end').value = eDate;
    document.getElementById('q_branch').value = branch;
    calcTarget('q');
    updateLivePreview();
}

function handleModalSubmit(e) {
    e.preventDefault();
    const entry = getFormData('m');
    const idx = salesData.findIndex(i => i.id === entry.id);
    if (idx > -1) salesData[idx] = entry;
    else salesData.push(entry);
    saveData();
    closeModal();
    showToast('Saved Successfully');
}

function openEdit(id) {
    const item = salesData.find(i => i.id === id);
    if (!item) return;
    
    // Handle legacy data
    const dStart = item.date_start || item.date;
    const dEnd = item.date_end || item.date;

    document.getElementById('m_id').value = item.id;
    document.getElementById('m_branch').value = item.branch;
    document.getElementById('m_date_start').value = dStart;
    document.getElementById('m_date_end').value = dEnd;
    document.getElementById('m_target').value = item.target;

    ['delivery', 'online', 'aggregator', 'dining'].forEach(ch => {
        document.getElementById(`m_${ch}`).value = item[ch];
        document.getElementById(`m_${ch}_trans`).value = item[`${ch}_trans`];
    });

    document.getElementById('modalTitle').textContent = 'Edit Entry';
    document.getElementById('entryModal').classList.add('open');
}

function deleteEntry(id) {
    if(confirm('Delete this record?')) {
        salesData = salesData.filter(i => i.id !== id);
        saveData();
        showToast('Deleted', 'error');
    }
}

function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(salesData));
    updateDashboard();
}

// --- UI ---
function openModal() {
    document.getElementById('modalForm').reset();
    document.getElementById('m_id').value = '';
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('m_date_start').value = today;
    document.getElementById('m_date_end').value = today;
    document.getElementById('modalTitle').textContent = 'New Entry';
    document.getElementById('entryModal').classList.add('open');
}
function closeModal() { document.getElementById('entryModal').classList.remove('open'); }
function showToast(msg, type='success') {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    t.style.borderLeft = type === 'success' ? '5px solid var(--success-color)' : '5px solid var(--danger-color)';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// --- CHARTS ---
function initCharts() {
    const ctx = document.getElementById('perfChart').getContext('2d');
    charts.perf = new Chart(ctx, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } }
    });
}

function updatePerfChart(data) {
    const stats = {};
    data.forEach(i => {
        if(!stats[i.branch]) stats[i.branch] = { sales: 0, target: 0 };
        stats[i.branch].sales += i.total;
        stats[i.branch].target += i.target;
    });
    const rankings = Object.keys(stats).map(b => ({
        name: b.replace('Crispy Chicken ', ''),
        sales: stats[b].sales, target: stats[b].target
    })).sort((a, b) => b.sales - a.sales).slice(0, 5);

    charts.perf.data.labels = rankings.map(r => r.name);
    charts.perf.data.datasets = [
        { label: 'Target', data: rankings.map(r => r.target), backgroundColor: '#e5e7eb' },
        { label: 'Actual', data: rankings.map(r => r.sales), backgroundColor: '#b30000' }
    ];
    charts.perf.update();
}

// --- CSV ---
function exportCSV() {
    if (!salesData.length) return showToast('No data', 'error');
    // Updated headers for date range
    const headers = ['ID,Branch,Date_Start,Date_End,Delivery,Delivery_Trans,Online,Online_Trans,Aggregator,Aggregator_Trans,Dining,Dining_Trans,Total,Total_Trans,Target'];
    const rows = salesData.map(d => 
        `${d.id},"${d.branch}",${d.date_start||d.date},${d.date_end||d.date},${d.delivery},${d.delivery_trans},${d.online},${d.online_trans},${d.aggregator},${d.aggregator_trans},${d.dining},${d.dining_trans},${d.total},${d.total_trans},${d.target}`
    );
    const csvContent = "\uFEFF" + headers.concat(rows).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Crispy_Data_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function importCSV(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        let count = 0;
        // Skip header
        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].trim();
            if (!row) continue;
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/^"|"$/g, ''));
            // Old format had fewer columns, new has date_start/end
            // Try to detect format. If cols.length >= 15, new format.
            if (cols.length >= 5) {
                const d_s = parseFloat(cols[4])||0, d_t = parseFloat(cols[5])||0;
                const o_s = parseFloat(cols[6])||0, o_t = parseFloat(cols[7])||0;
                const a_s = parseFloat(cols[8])||0, a_t = parseFloat(cols[9])||0;
                const di_s = parseFloat(cols[10])||0, di_t = parseFloat(cols[11])||0;
                
                // Handle Date columns
                let dateStart = '', dateEnd = '';
                if(cols.length >= 15) { // New format
                    dateStart = cols[2];
                    dateEnd = cols[3];
                } else { // Old format (date was index 1)
                    dateStart = cols[1];
                    dateEnd = cols[1];
                }

                salesData.push({
                    id: parseInt(cols[0]) || Date.now() + i,
                    branch: cols[cols.length >= 15 ? 1 : 2], // Adjust index based on format
                    date_start: dateStart, date_end: dateEnd,
                    delivery: d_s, delivery_trans: d_t,
                    online: o_s, online_trans: o_t,
                    aggregator: a_s, aggregator_trans: a_t,
                    dining: di_s, dining_trans: di_t,
                    total: d_s+o_s+a_s+di_s, total_trans: d_t+o_t+a_t+di_t,
                    target: parseFloat(cols[cols.length >= 15 ? 14 : 13])||0
                });
                count++;
            }
        }
        saveData();
        showToast(`Imported ${count} records`);
        input.value = '';
    };
    reader.readAsText(file);
}
</script>
</body>
</html>
