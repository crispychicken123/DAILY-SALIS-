<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crispy Chicken - Advanced Analytics</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --primary-color: #b30000;
    --primary-dark: #8a0000;
    --secondary-color: #e63946;
    --dark-color: #1d3557;
    --success-color: #2a9d8f;
    --warning-color: #e9c46a;
    --danger-color: #e76f51;
    --info-color: #457b9d;
    --bg-color: #f3f4f6;
    --card-bg: #ffffff;
    --text-main: #1f2937;
    --text-muted: #6b7280;
    --border-color: #e5e7eb;
    --border-radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --transition: all 0.2s ease-in-out;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }

body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; padding-bottom: 40px; }

/* --- Layout --- */
.container { max-width: 1800px; margin: 0 auto; padding: 20px; }
.grid-dashboard { display: grid; grid-template-columns: 340px 1fr; gap: 24px; }
.grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }

@media (max-width: 1200px) { .grid-dashboard { grid-template-columns: 1fr; } }

/* --- Header --- */
header {
    background: var(--card-bg); padding: 20px 30px; border-radius: var(--border-radius);
    margin-bottom: 24px; box-shadow: var(--shadow-lg);
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    border-bottom: 4px solid var(--primary-color);
}
h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 12px; color: var(--primary-color); }

/* --- Buttons --- */
.btn {
    padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;
    font-size: 0.9rem; transition: var(--transition); display: inline-flex; align-items: center; gap: 8px;
}
.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
.btn-primary { background: var(--primary-color); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: white; border: 1px solid var(--border-color); color: var(--text-main); }
.btn-success { background: var(--success-color); color: white; }
.btn-danger { background: var(--danger-color); color: white; }
.btn-sm { padding: 6px 12px; font-size: 0.8rem; }

/* --- Components --- */
.card {
    background: var(--card-bg); border-radius: var(--border-radius);
    padding: 20px; box-shadow: var(--shadow); height: 100%; display: flex; flex-direction: column;
}
.card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--bg-color);
}
.card-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }

/* --- Channel Input Group (Sales + Trans together) --- */
.channel-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 12px; }
.channel-group { border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; background: #fafafa; }
.channel-group label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
.channel-group input { font-size: 0.85rem; padding: 6px; margin-bottom: 4px; }

@media(max-width: 768px) { .channel-row { grid-template-columns: 1fr 1fr; } }

/* --- KPI Cards & Summary --- */
.kpi-card { position: relative; overflow: hidden; }
.kpi-card::before { content:''; position: absolute; top:0; left:0; width:4px; height:100%; background:var(--primary-color); }
.kpi-value { font-size: 1.8rem; font-weight: 800; margin: 8px 0; color: var(--dark-color); }
.kpi-label { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }

/* New Channel Summary Box */
.summary-breakdown {
    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;
    grid-column: 1 / -1; /* Span full width */
}
.summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
.sum-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
.sum-item strong { color: var(--dark-color); display: block; margin-bottom: 2px; }
.sum-item span { color: var(--text-muted); font-size: 0.85rem; }
.sum-val { text-align: right; }
.sum-main { font-weight: 700; color: var(--primary-color); }
.sum-sub { font-size: 0.8rem; color: var(--text-muted); }

/* --- Performance Section --- */
.performance-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; align-items: start; }
.rank-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.rank-table th { background: var(--dark-color); color: white; padding: 12px 15px; text-align: left; font-size: 0.85rem; }
.rank-table td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; }
.rank-badge { width: 28px; height: 28px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 0.8rem; }
.rank-1 { background: #FFD700; box-shadow: 0 2px 5px rgba(255, 215, 0, 0.4); }
.status-pill { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
.status-top { background: #d1fae5; color: #065f46; }
.status-ok { background: #e0f2fe; color: #1e40af; }
.status-low { background: #fee2e2; color: #991b1b; }

/* --- Main Table --- */
.table-responsive { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border-color); }
.main-table th { background: var(--bg-color); color: var(--text-muted); padding: 12px 15px; text-align: left; font-size: 0.8rem; white-space: nowrap; }
.main-table td { padding: 12px 15px; border-top: 1px solid var(--border-color); font-size: 0.9rem; white-space: nowrap; }
.main-table tr:hover { background-color: #f9fafb; }
.col-num { text-align: right; }

/* --- Forms --- */
.form-group { margin-bottom: 16px; }
label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
input, select {
    width: 100%; padding: 10px 12px; border: 1px solid var(--border-color);
    border-radius: 6px; font-size: 0.95rem; transition: var(--transition); background: #fff;
}
.auto-calc { background-color: #f0fdf4; border-color: #86efac; color: #166534; cursor: pointer; }

/* --- Modal --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(3px);
    z-index: 1000; display: flex; align-items: center; justify-content: center;
    opacity: 0; visibility: hidden; transition: var(--transition);
}
.modal-overlay.open { opacity: 1; visibility: visible; }
.modal {
    background: white; width: 90%; max-width: 700px; border-radius: var(--border-radius);
    padding: 25px; box-shadow: var(--shadow-lg); transform: scale(0.9); transition: var(--transition);
    max-height: 90vh; overflow-y: auto;
}
.modal-overlay.open .modal { transform: scale(1); }

/* --- Toast --- */
.toast {
    position: fixed; bottom: 20px; right: 20px; z-index: 2000;
    background: var(--dark-color); color: white; padding: 12px 20px;
    border-radius: 8px; box-shadow: var(--shadow-lg);
    transform: translateY(100px); opacity: 0; transition: var(--transition);
}
.toast.show { transform: translateY(0); opacity: 1; }
</style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-drumstick-bite"></i> Crispy Chicken Analytics</h1>
        <div style="display: flex; gap: 10px; align-items: center;">
            <span id="currentDate" style="color:var(--text-muted); font-size: 0.9rem; font-weight: 500;"></span>
            <button class="btn btn-secondary" onclick="document.getElementById('csvInput').click()">
                <i class="fas fa-file-import"></i> Import CSV
            </button>
            <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="importCSV(this)">
            <button class="btn btn-secondary" onclick="exportCSV()">
                <i class="fas fa-download"></i> Export
            </button>
            <button class="btn btn-primary" onclick="openModal()">
                <i class="fas fa-plus"></i> New Entry
            </button>
        </div>
    </header>

    <!-- KPI & Channel Summary -->
    <div class="grid-kpi">
        <div class="card kpi-card">
            <i class="fas fa-coins" style="position: absolute; right: 20px; top: 20px; opacity: 0.1; font-size: 2rem;"></i>
            <div class="kpi-label">Total Sales</div>
            <div class="kpi-value" id="kpi-sales">AED 0</div>
            <div style="color: var(--text-muted); font-size: 0.8rem;" id="kpi-record-count">0 Records</div>
        </div>
        <div class="card kpi-card">
            <i class="fas fa-receipt" style="position: absolute; right: 20px; top: 20px; opacity: 0.1; font-size: 2rem;"></i>
            <div class="kpi-label">Total Trans</div>
            <div class="kpi-value" id="kpi-trans">0</div>
            <div style="color: var(--success-color); font-size: 0.8rem;" id="kpi-avg-ticket">Avg: AED 0</div>
        </div>
        <div class="card kpi-card">
            <i class="fas fa-bullseye" style="position: absolute; right: 20px; top: 20px; opacity: 0.1; font-size: 2rem;"></i>
            <div class="kpi-label">Achievement</div>
            <div class="kpi-value" id="kpi-ach">0%</div>
            <div style="color: var(--text-muted); font-size: 0.8rem;" id="kpi-target-display">Target: AED 0</div>
        </div>
    </div>

    <!-- New Channel Breakdown Summary -->
    <div class="card summary-breakdown">
        <div style="margin-bottom: 10px; font-weight: 700; color: var(--dark-color); font-size: 0.9rem; display: flex; gap: 10px;">
            <i class="fas fa-chart-pie"></i> Channel Breakdown (Sales & Transactions)
        </div>
        <div class="summary-grid">
            <div class="sum-item">
                <div><strong>Delivery</strong><span>Vol: <span id="sum-delivery-sales">0</span></span></div>
                <div class="sum-val"><div class="sum-main" id="sum-delivery-trans">0 Trx</div><div class="sum-sub">Avg: <span id="sum-delivery-avg">0</span></div></div>
            </div>
            <div class="sum-item">
                <div><strong>Online</strong><span>Vol: <span id="sum-online-sales">0</span></span></div>
                <div class="sum-val"><div class="sum-main" id="sum-online-trans">0 Trx</div><div class="sum-sub">Avg: <span id="sum-online-avg">0</span></div></div>
            </div>
            <div class="sum-item">
                <div><strong>Aggregator</strong><span>Vol: <span id="sum-agg-sales">0</span></span></div>
                <div class="sum-val"><div class="sum-main" id="sum-agg-trans">0 Trx</div><div class="sum-sub">Avg: <span id="sum-agg-avg">0</span></div></div>
            </div>
            <div class="sum-item">
                <div><strong>Dining</strong><span>Vol: <span id="sum-dining-sales">0</span></span></div>
                <div class="sum-val"><div class="sum-main" id="sum-dining-trans">0 Trx</div><div class="sum-sub">Avg: <span id="sum-dining-avg">0</span></div></div>
            </div>
        </div>
    </div>

    <div class="grid-dashboard">
        <!-- Sidebar: Quick Entry -->
        <aside>
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-edit"></i> Quick Entry</div>
                </div>
                <form id="quickForm" onsubmit="handleQuickSubmit(event)">
                    <div class="form-group">
                        <label>Branch *</label>
                        <select id="q_branch" required onchange="calcTarget('q')">
                            <option value="">Select Branch...</option>
                        </select>
                    </div>
                    <div class="input-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div class="form-group"><label>Date *</label><input type="date" id="q_date" required onchange="calcTarget('q')"></div>
                        <div class="form-group"><label>Daily Target</label><input type="number" id="q_target" step="0.01" class="auto-calc" readonly></div>
                    </div>
                    
                    <label style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; margin-top:10px;">Channel Data (Sales & Trans)</label>
                    
                    <!-- Delivery -->
                    <div class="channel-row">
                        <div class="channel-group" style="border-left: 3px solid var(--primary-color);">
                            <label>Delivery</label>
                            <input type="number" id="q_delivery" step="0.01" min="0" placeholder="Sales">
                            <input type="number" id="q_delivery_trans" min="0" placeholder="Trans">
                        </div>
                        <!-- Online -->
                        <div class="channel-group" style="border-left: 3px solid var(--secondary-color);">
                            <label>Online</label>
                            <input type="number" id="q_online" step="0.01" min="0" placeholder="Sales">
                            <input type="number" id="q_online_trans" min="0" placeholder="Trans">
                        </div>
                        <!-- Aggregator -->
                        <div class="channel-group" style="border-left: 3px solid var(--info-color);">
                            <label>Aggregator</label>
                            <input type="number" id="q_aggregator" step="0.01" min="0" placeholder="Sales">
                            <input type="number" id="q_aggregator_trans" min="0" placeholder="Trans">
                        </div>
                        <!-- Dining -->
                        <div class="channel-group" style="border-left: 3px solid var(--warning-color);">
                            <label>Dining</label>
                            <input type="number" id="q_dining" step="0.01" min="0" placeholder="Sales">
                            <input type="number" id="q_dining_trans" min="0" placeholder="Trans">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; margin-top: 20px;">
                        <i class="fas fa-save"></i> Save Entry
                    </button>
                </form>
            </div>
        </aside>

        <!-- Main Content -->
        <main>
            <!-- Performance Board -->
            <section class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-trophy"></i> Branch Performance Ranking</div>
                    <select id="perfPeriod" class="btn btn-secondary btn-sm" onchange="updateDashboard()">
                        <option value="today">Today</option>
                        <option value="week" selected>Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                    </select>
                </div>
                <div class="performance-grid">
                    <div>
                        <table class="rank-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Branch</th>
                                    <th style="text-align: right;">Target</th>
                                    <th style="text-align: right;">Actual</th>
                                    <th style="text-align: center;">Ach %</th>
                                </tr>
                            </thead>
                            <tbody id="rankBody"></tbody>
                        </table>
                    </div>
                    <div style="height: 250px; position: relative;">
                        <canvas id="perfChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Detailed Data Table -->
            <section class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-list"></i> Transaction History (Detailed)</div>
                    <div style="display: flex; gap: 10px;">
                        <select id="filterBranch" onchange="updateDashboard()" style="padding: 6px; border-radius: 4px;">
                            <option value="all">All Branches</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="main-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Branch</th>
                                <th class="col-num">Del. S/T</th>
                                <th class="col-num">On. S/T</th>
                                <th class="col-num">Agg. S/T</th>
                                <th class="col-num">Din. S/T</th>
                                <th class="col-num">Total Sales</th>
                                <th class="col-num">Total Trans</th>
                                <th class="col-num">Ach %</th>
                                <th style="text-align: right;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div id="emptyState" style="text-align: center; padding: 40px; color: var(--text-muted); display: none;">
                    <p>No records found</p>
                </div>
            </section>
        </main>
    </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="entryModal">
    <div class="modal">
        <div class="modal-header">
            <div class="card-title" id="modalTitle">Edit Entry</div>
            <button class="btn btn-secondary btn-sm" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <form id="modalForm" onsubmit="handleModalSubmit(event)">
            <input type="hidden" id="m_id">
            <div class="input-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group"><label>Branch</label><select id="m_branch" required onchange="calcTarget('m')"></select></div>
                <div class="form-group"><label>Date</label><input type="date" id="m_date" required onchange="calcTarget('m')"></div>
                <div class="form-group"><label>Target</label><input type="number" id="m_target" step="0.01" class="auto-calc" readonly></div>
            </div>
            
            <label style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase;">Channel Details</label>
            <!-- Modal Inputs -->
            <div class="channel-row">
                <div class="channel-group">
                    <label>Delivery</label>
                    <input type="number" id="m_delivery" step="0.01" placeholder="Sales">
                    <input type="number" id="m_delivery_trans" placeholder="Trans">
                </div>
                <div class="channel-group">
                    <label>Online</label>
                    <input type="number" id="m_online" step="0.01" placeholder="Sales">
                    <input type="number" id="m_online_trans" placeholder="Trans">
                </div>
                <div class="channel-group">
                    <label>Aggregator</label>
                    <input type="number" id="m_aggregator" step="0.01" placeholder="Sales">
                    <input type="number" id="m_aggregator_trans" placeholder="Trans">
                </div>
                <div class="channel-group">
                    <label>Dining</label>
                    <input type="number" id="m_dining" step="0.01" placeholder="Sales">
                    <input type="number" id="m_dining_trans" placeholder="Trans">
                </div>
            </div>
            
            <div class="modal-footer" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<div class="toast" id="toast"><i class="fas fa-check-circle"></i> <span id="toastMsg">Saved</span></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- CONFIG ---
const STORAGE_KEY = 'crispy_analytics_v3';
let salesData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let charts = {};

const BRANCH_CONFIG = {
    "Crispy Chicken Hamdan": 840000,
    "Crispy Chicken Shabiya": 800000,
    "Crispy Chicken Khaldia": 750000,
    "Crispy Chicken Muroor": 620000,
    "Crispy Chicken Al Barsha": 800000,
    "Crispy Chicken Al Satwa": 650000,
    "Crispy Chicken ELctria": 1000000,
    "Crispy Chicken Al Rgga": 815000,
    "Crispy Chicken Majaz": 400000,
    "Crispy Chicken Call Center": 265000
};

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('q_date').value = today;
    document.getElementById('m_date').value = today;
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    const branchList = [document.getElementById('q_branch'), document.getElementById('m_branch'), document.getElementById('filterBranch')];
    branchList.forEach(sel => {
        Object.keys(BRANCH_CONFIG).forEach(branch => {
            const opt = document.createElement('option');
            opt.value = branch;
            opt.textContent = branch.replace('Crispy Chicken ', '');
            sel.appendChild(opt);
        });
    });

    initCharts();
    updateDashboard();
});

// --- LOGIC ---
function calcTarget(prefix) {
    const branch = document.getElementById(`${prefix}_branch`).value;
    const dateStr = document.getElementById(`${prefix}_date`).value;
    const targetInput = document.getElementById(`${prefix}_target`);
    if (branch && dateStr && BRANCH_CONFIG[branch]) {
        const date = new Date(dateStr);
        const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        targetInput.value = (BRANCH_CONFIG[branch] / daysInMonth).toFixed(2);
    } else {
        targetInput.value = 0;
    }
}

function getFormData(prefix) {
    // Helper to get float or 0
    const val = (id) => parseFloat(document.getElementById(id).value) || 0;

    const d_sales = val(`${prefix}_delivery`);
    const d_trans = val(`${prefix}_delivery_trans`);
    
    const o_sales = val(`${prefix}_online`);
    const o_trans = val(`${prefix}_online_trans`);
    
    const a_sales = val(`${prefix}_aggregator`);
    const a_trans = val(`${prefix}_aggregator_trans`);
    
    const di_sales = val(`${prefix}_dining`);
    const di_trans = val(`${prefix}_dining_trans`);

    const total_sales = d_sales + o_sales + a_sales + di_sales;
    const total_trans = d_trans + o_trans + a_trans + di_trans;

    return {
        id: document.getElementById(`${prefix}_id`).value ? parseInt(document.getElementById(`${prefix}_id`).value) : Date.now(),
        branch: document.getElementById(`${prefix}_branch`).value,
        date: document.getElementById(`${prefix}_date`).value,
        target: val(`${prefix}_target`),
        // Sales
        delivery: d_sales, online: o_sales, aggregator: a_sales, dining: di_sales, total: total_sales,
        // Transactions
        delivery_trans: d_trans, online_trans: o_trans, aggregator_trans: a_trans, dining_trans: di_trans, total_trans: total_trans
    };
}

function getFilteredData() {
    const period = document.getElementById('perfPeriod').value;
    const branchFilter = document.getElementById('filterBranch').value;
    const today = new Date(); today.setHours(0,0,0,0);
    
    let cutoff = new Date(today);
    if (period === 'week') cutoff.setDate(today.getDate() - 7);
    if (period === 'month') cutoff.setDate(today.getDate() - 30);
    if (period === 'all') cutoff = new Date('2020-01-01');

    return salesData.filter(item => {
        const itemDate = new Date(item.date);
        const dateMatch = itemDate >= cutoff && itemDate <= new Date(today.setHours(23,59,59,999));
        const branchMatch = branchFilter === 'all' || item.branch === branchFilter;
        return dateMatch && branchMatch;
    }).sort((a, b) => new Date(b.date) - new Date(a.date));
}

function updateDashboard() {
    const data = getFilteredData();
    renderKPIs(data);
    renderTable(data);
    renderPerformanceBoard(data);
    updateCharts(data);
}

// --- RENDERING ---
function renderKPIs(data) {
    // Totals
    const totalSales = data.reduce((sum, i) => sum + i.total, 0);
    const totalTrans = data.reduce((sum, i) => sum + i.total_trans, 0);
    const totalTarget = data.reduce((sum, i) => sum + i.target, 0);
    const ach = totalTarget ? ((totalSales / totalTarget) * 100).toFixed(1) : 0;
    const avgTicket = totalTrans ? (totalSales / totalTrans).toFixed(1) : 0;

    document.getElementById('kpi-sales').textContent = `AED ${totalSales.toLocaleString()}`;
    document.getElementById('kpi-trans').textContent = totalTrans.toLocaleString();
    document.getElementById('kpi-ach').textContent = `${ach}%`;
    document.getElementById('kpi-avg-ticket').textContent = `Avg: AED ${avgTicket}`;
    document.getElementById('kpi-target-display').textContent = `Target: AED ${totalTarget.toLocaleString()}`;
    document.getElementById('kpi-record-count').textContent = `${data.length} Records`;

    // Channel Breakdowns
    const channels = ['delivery', 'online', 'aggregator', 'dining'];
    channels.forEach(ch => {
        const sales = data.reduce((sum, i) => sum + i[ch], 0);
        const trans = data.reduce((sum, i) => sum + i[`${ch}_trans`], 0);
        const avg = trans ? (sales / trans).toFixed(1) : 0;
        
        document.getElementById(`sum-${ch}-sales`).textContent = `AED ${sales.toLocaleString()}`;
        document.getElementById(`sum-${ch}-trans`).textContent = `${trans.toLocaleString()} Trx`;
        document.getElementById(`sum-${ch}-avg`).textContent = `AED ${avg}`;
    });
}

function renderPerformanceBoard(data) {
    const stats = {};
    Object.keys(BRANCH_CONFIG).forEach(b => stats[b] = { sales: 0, target: 0 });
    
    data.forEach(i => {
        if(!stats[i.branch]) stats[i.branch] = { sales: 0, target: 0 };
        stats[i.branch].sales += i.total;
        stats[i.branch].target += i.target;
    });

    const rankings = Object.keys(stats).map(b => {
        const s = stats[b];
        const ach = s.target ? (s.sales / s.target) * 100 : 0;
        return { name: b.replace('Crispy Chicken ', ''), sales: s.sales, target: s.target, ach: ach.toFixed(1) };
    }).sort((a, b) => parseFloat(b.ach) - parseFloat(a.ach));

    document.getElementById('rankBody').innerHTML = rankings.map((r, i) => `
        <tr>
            <td><span class="rank-badge rank-${i+1} ${i>3?'rank-default':''}">${i+1}</span></td>
            <td>${r.name}</td>
            <td style="text-align: right;">${r.target.toLocaleString()}</td>
            <td style="text-align: right; font-weight:bold;">${r.sales.toLocaleString()}</td>
            <td style="text-align: center;">${r.ach}%</td>
        </tr>
    `).join('');

    updatePerfChart(rankings.slice(0, 5));
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    const empty = document.getElementById('emptyState');
    const table = document.getElementById('dataTable');

    if (data.length === 0) {
        tbody.innerHTML = ''; table.style.display = 'none'; empty.style.display = 'block'; return;
    }
    
    table.style.display = 'table'; empty.style.display = 'none';
    
    tbody.innerHTML = data.map(item => {
        const ach = item.target ? Math.round((item.total / item.target) * 100) : 0;
        const achColor = ach >= 100 ? 'var(--success-color)' : (ach < 80 ? 'var(--danger-color)' : 'var(--warning-color)');
        
        // Helper for format
        const fmt = (n) => n.toLocaleString();

        return `
        <tr>
            <td>${item.date}</td>
            <td><span style="font-weight:600;">${item.branch.replace('Crispy Chicken ', '')}</span></td>
            <td class="col-num">${fmt(item.delivery)}<br><small style="color:#888">${item.delivery_trans}t</small></td>
            <td class="col-num">${fmt(item.online)}<br><small style="color:#888">${item.online_trans}t</small></td>
            <td class="col-num">${fmt(item.aggregator)}<br><small style="color:#888">${item.aggregator_trans}t</small></td>
            <td class="col-num">${fmt(item.dining)}<br><small style="color:#888">${item.dining_trans}t</small></td>
            <td class="col-num" style="font-weight:bold;">AED ${fmt(item.total)}</td>
            <td class="col-num">${item.total_trans}</td>
            <td class="col-num"><span style="color:${achColor}; font-weight:bold;">${ach}%</span></td>
            <td style="text-align: right;">
                <button class="btn btn-secondary btn-sm" onclick="openEdit(${item.id})"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger btn-sm" onclick="deleteEntry(${item.id})"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');
}

// --- FORM ACTIONS ---
function handleQuickSubmit(e) {
    e.preventDefault();
    const entry = getFormData('q');
    entry.id = Date.now();
    salesData.push(entry);
    saveData();
    e.target.reset();
    document.getElementById('q_date').valueAsDate = new Date();
    showToast('Entry Added');
}

function handleModalSubmit(e) {
    e.preventDefault();
    const entry = getFormData('m');
    const idx = salesData.findIndex(i => i.id === entry.id);
    if (idx > -1) salesData[idx] = entry;
    else salesData.push(entry);
    saveData();
    closeModal();
}

function openEdit(id) {
    const item = salesData.find(i => i.id === id);
    if (!item) return;
    
    // Fill basic
    ['id', 'branch', 'date', 'target', 'delivery', 'online', 'aggregator', 'dining',
     'delivery_trans', 'online_trans', 'aggregator_trans', 'dining_trans'].forEach(k => {
        const el = document.getElementById(`m_${k}`);
        if(el) el.value = item[k];
    });

    document.getElementById('modalTitle').textContent = 'Edit Entry';
    document.getElementById('entryModal').classList.add('open');
}

function deleteEntry(id) {
    if(confirm('Delete entry?')) {
        salesData = salesData.filter(i => i.id !== id);
        saveData();
        showToast('Deleted', 'error');
    }
}

function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(salesData));
    updateDashboard();
}

// --- UI HELPERS ---
function openModal() {
    document.getElementById('modalForm').reset();
    document.getElementById('m_id').value = '';
    document.getElementById('m_date').valueAsDate = new Date();
    document.getElementById('modalTitle').textContent = 'New Entry';
    document.getElementById('entryModal').classList.add('open');
}
function closeModal() { document.getElementById('entryModal').classList.remove('open'); }
function showToast(msg, type='success') {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    t.style.borderLeft = type === 'success' ? '4px solid var(--success-color)' : '4px solid var(--danger-color)';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// --- CHARTS ---
function initCharts() {
    charts.perf = new Chart(document.getElementById('perfChart'), {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { grid: { display: false } }, y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });
}

function updatePerfChart(top5) {
    charts.perf.data.labels = top5.map(r => r.name);
    charts.perf.data.datasets = [
        { label: 'Target', data: top5.map(r => r.target), backgroundColor: '#e5e7eb', borderRadius: 4 },
        { label: 'Actual', data: top5.map(r => r.sales), backgroundColor: '#b30000', borderRadius: 4 }
    ];
    charts.perf.update();
}

function updateCharts(data) { 
    // Placeholder if more charts needed
}

// --- CSV ---
function exportCSV() {
    if (!salesData.length) return showToast('No data', 'error');
    const headers = ['ID,Date,Branch,Delivery,Delivery_Trans,Online,Online_Trans,Aggregator,Aggregator_Trans,Dining,Dining_Trans,Total,Total_Trans,Target'];
    const rows = salesData.map(d => 
        `${d.id},${d.date},"${d.branch}",${d.delivery},${d.delivery_trans},${d.online},${d.online_trans},${d.aggregator},${d.aggregator_trans},${d.dining},${d.dining_trans},${d.total},${d.total_trans},${d.target}`
    );
    const blob = new Blob([headers.concat(rows).join('\n')], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `Crispy_Data_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

function importCSV(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        let count = 0;
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].trim();
            if(!row) continue;
            const c = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/^"|"$/g, ''));
            if(c.length >= 4) {
                salesData.push({
                    id: parseInt(c[0]) || Date.now() + i, date: c[1], branch: c[2],
                    delivery: parseFloat(c[3])||0, delivery_trans: parseFloat(c[4])||0,
                    online: parseFloat(c[5])||0, online_trans: parseFloat(c[6])||0,
                    aggregator: parseFloat(c[7])||0, aggregator_trans: parseFloat(c[8])||0,
                    dining: parseFloat(c[9])||0, dining_trans: parseFloat(c[10])||0,
                    total: parseFloat(c[11])||0, total_trans: parseFloat(c[12])||0,
                    target: parseFloat(c[13])||0
                });
                count++;
            }
        }
        saveData();
        showToast(`Imported ${count} rows`);
        input.value = '';
    };
    reader.readAsText(file);
}
</script>
</body>
</html>
